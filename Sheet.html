<div class="licensecontainer">
<input class="npc_toggle" name="attr_npc_toggle" type="hidden" value="0">

<div class="container npc" style="width: 350px;">
    <input class="npc_options-flag" type="checkbox" name="attr_npc_options-flag" checked="checked"><span>y</span>
    
</div>


<div class="container pc">

<input type="hidden" class="toggleflag" name="attr_toggleflag">
<div class="advantagetoggle">
    <input type="radio" class="toggle-left" name="attr_advantagetoggle" value="1d24"><span>AUGMENTED</span>
    <input type="radio" class="toggle-center" name="attr_advantagetoggle" value="1d20" checked="checked"><span>NORMAL</span>
    <input type="radio" class="toggle-right" name="attr_advantagetoggle" value="1d16"><span>PENALIZED</span>
</div>

<input class="tab-button core" type="radio" name="attr_tab" value="core" checked="checked"><span >CORE</span>
<input class="tab-button spells" type="radio" name="attr_tab" value="spells"><span>SPELLS</span>
<input class="tab-button options" type="radio" name="attr_tab" value="options"><span style="font-family: pictos">y</span>

<div class="page core">
    <div class="header">
        <div class="name-container">
            <img src="http://i.imgur.com/ZgULBCp.png" style="padding-bottom: 5px;">
            <input type="text" name="attr_character_name" style="width: 100%;">
            <span class="label">CHARACTER NAME</span>
        </div>
        
        <div class="header-info">
            <div class="top">
                <div class="hlabel-container">
                    <input class="flag" type="hidden" name="attr_customclass_flag" value="0">
                    <input class="showing" type="text" name="attr_cust_class" value="@{cust_classname}" disabled="true" style="width: 64px; height: 28px; padding-top: 10px;">
                    <select class="hiding" name="attr_class" style="width: 90px;">
                        <option value="Paladin">Paladin</option>
                        <option value="Heavy Knight">Heavy Knight</option>
                        <option value="Thug">Thug</option>
                        <option value="Inquisitor">Inquisitor</option>
                        <option value="Outrider">Outrider</option>
                        <option value="Shroud">Shroud</option>
                        <option value="Magus">Magus</option>
                        <option value="Mystic">Mystic</option>
                        <option value="Sorcerer">Sorcerer</option>
                        <option value="Inheritor">Inheritor</option>
                        <option value="Warlock">Warlock</option>
                        <option value="Druid">Druid</option>
                    </select>
                    <input type="number" name="attr_level" value="1" style="margin-left: -6px; width: 28px;">
                    <span class="label">CLASS & LEVEL</span>
                </div>
                <div class="hlabel-container">
                    <input type="text" name="attr_background" style="width: 122px;">
                    <span class="label">NEXT LEVEL</span>
                </div>
            </div>
            <div class="bottom">
                <div class="hlabel-container">
					<select  name="attr_race" style="width: 64px; height: 19px; padding: 0px;">
                        <option value="Black Orc">Black Orc</option>
                        <option value="Bogill">Bogill</option>
                        <option value="Devilkin">Devilkin</option>
                        <option value="Giant">Giant</option>
                        <option value="Human">Human</option>
                        <option value="Hobgoblin">Hobgoblin</option>
                        <option value="Red Troll">Red Troll</option>
                    </select>
                    <span class="label">RACE</span>
                </div>
                <div class="hlabel-container">
					<select name="attr_size" style="width: 64px; height: 19px; padding: 0px;">
                        <option value="medium">Medium</option>
                        <option value="large">Large</option>
                    </select>
                    <span class="label">SIZE</span>
                </div>
                <div class="hlabel-container">
                    <input type="text" name="attr_experience">
                    <span class="label">EXPERIENCE POINTS</span>
                </div>
            </div>
        </div>
    
    </div>
    <div class="body">
        <div class="col col1">
            <div class="attributes-container" style="margin-top: 10px;">
                <div class="attr-container">
                    <button type="roll" name="roll_physique" value="@{wtype}&{template:simple} {{rname=PHYSIQUE TEST}} {{mod=[[[[@{physique_mod}]][PHYSIQUE]]]}} {{r1=[[@{physique_strength}+[[@{physique_mod}]]-[[floor(@{affliction}/2)]][STRENGTH+PHYSIQUE]]]}} @{charname_output}">PHYSIQUE</button>
                    <input class="attr" type="text" name="attr_physique_mod" title="@{physique_mod}" value="0">
					<div>
						<select class="hiding" name="attr_physique_strength" title="@{physique_strength}" value="-">
							<option value="2d6">-</option>
							<option value="2d8">Strong</option>
							<option value="2d4">Weak</option>
						</select>
					</div>
                    <div class="attr-mod">
                        <input type="text" name="attr_physique" title="@{physique}" value="10">
                    </div>
                </div>
                <div class="attr-container">
                    <button type="roll" name="roll_cunning" value="@{wtype}&{template:simple} {{rname=CUNNING TEST}} {{mod=[[[[@{cunning_mod}]][CUNNING]]]}} {{r1=[[@{cunning_strength}+[[@{cunning_mod}]]-[[floor(@{affliction}/2)]][STRENGTH+CUNNING]]]}} @{charname_output}">CUNNING</button>
                    <input class="attr" type="text" name="attr_cunning_mod" title="@{cunning_mod}" value="0">
					<div>
						<select class="hiding" name="attr_cunning_strength" title="@{cunning_strength}" value="-">
							<option value="2d6">-</option>
							<option value="2d8">Strong</option>
							<option value="2d4">Weak</option>
						</select>
					</div>
                    <div class="attr-mod">
                        <input type="text" name="attr_cunning" title="@{cunning}" value="10">
                    </div>
                </div>
                <div class="attr-container">
                    <button type="roll" name="roll_ego" value="@{wtype}&{template:simple} {{rname=EGO TEST}} {{mod=[[[[@{ego_mod}]][EGO]]]}} {{r1=[[@{ego_strength}+[[@{ego_mod}]]-[[floor(@{affliction}/2)]][STRENGTH+EGO]]]}} @{charname_output}">EGO</button>
                    <input class="attr" type="text" name="attr_ego_mod" title="@{ego_mod}" value="0">
					<div>
						<select class="hiding" name="attr_ego_strength" title="@{ego_strength}" value="-">
							<option value="2d6">-</option>
							<option value="2d8">Strong</option>
							<option value="2d4">Weak</option>
						</select>
					</div>
                    <div class="attr-mod">
                        <input type="text" name="attr_ego" title="@{ego}" value="10">
                    </div>
                </div>
                <div class="attr-container">
                    <button type="roll" name="roll_charisma" value="@{wtype}&{template:simple} {{rname=CHARISMA TEST}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{charisma_strength}+[[@{charisma_mod}]]-[[floor(@{affliction}/2)]][STRENGTH+CHA]]]}} @{charname_output}">CHARISMA</button>
                    <input class="attr" type="text" name="attr_charisma_mod" title="@{charisma_mod}" value="0">
					<div>
						<select class="hiding" name="attr_charisma_strength" title="@{charisma_strength}">
							<option value="2d6">-</option>
							<option value="2d8">Strong</option>
							<option value="2d4">Weak</option>
						</select>
					</div>
                    <div class="attr-mod">
                        <input type="text" name="attr_charisma" title="@{charisma}" value="10">
                    </div>
                </div>
				<div class="attr-container" style="height: 59px;">
                    <button type="roll">WICKEDNESS</button>
                    <input class="attr" type="text" name="attr_wickedness" title="@{wickedness}" value="10">
                </div>
				<div class="attr-container"  style="height: 59px;">
                    <button type="roll">AFFLICTION</button>
                    <input class="attr" type="text" name="attr_affliction" title="@{affliction}" value="0">
                </div>
            </div>
            <div class="skills-saves-container">
                <div class="hb-attacks-container">
					<!-- sqrt() doesn't work in Roll20 -->
					<input type="hidden" disabled="true" name="attr_sq_guess0" value="1" />
					<input type="hidden" disabled="true" name="attr_sq_guess1" value="((@{sq_guess0} + @{level} / @{sq_guess0}) / 2)" />
					<input type="hidden" disabled="true" name="attr_sq_guess2" value="((@{sq_guess1} + @{level} / @{sq_guess1}) / 2)" />
					<input type="hidden" disabled="true" name="attr_sq_guess3" value="((@{sq_guess2} + @{level} / @{sq_guess2}) / 2)" />
					<input type="hidden" disabled="true" name="attr_sq_guess4" value="((@{sq_guess3} + @{level} / @{sq_guess3}) / 2)" />
					<input type="hidden" disabled="true" name="attr_sq_guess5" value="((@{sq_guess4} + @{level} / @{sq_guess4}) / 2)" />
					<input type="hidden" disabled="true" name="attr_sq_guess6" value="((@{sq_guess5} + @{level} / @{sq_guess5}) / 2)" />

					<input type="hidden" disabled="true" name="attr_squrt" value="@{sq_guess6}" />
					<div class="value">
                        <input type="text" name="attr_hb" title="@{hb}" value="1">
                    </div>
                    <div class="label">
                        <span>HEROIC BONUS</span>
                    </div>
                </div>
				<div class="hb-attacks-container">
					<div class="value">
						<input type="text" name="attr_physical_attack_mod" title="@{physical_attack_mod}" value="0">
					</div>
					<div class="label">
						<button class="attacks-saving-throws" type="roll" name="roll_physical_attack" value="@{wtype}&{template:simple} {{rname=PHYSICAL ATTACK}} {{mod=[[[[@{physical_attack_mod}]][PHYSICAL ATTACK]]]}} {{r1=[[@{advantagetoggle}+[[@{physical_attack_mod]]-[[floor(@{affliction}/2)]] [PHYSICAL ATTACK]]]}} @{charname_output}">PHYSICAL ATTACK</button>
					</div>
				</div>
				<div class="hb-attacks-container">
					<div class="value">
						<input type="text" name="attr_magical_attack_mod" title="@{magical_attack_mod}" value="0">
					</div>
					<div class="label">
						<button class="attacks-saving-throws" type="roll" name="roll_magical_attack" value="@{wtype}&{template:simple} {{rname=MAGICAL ATTACK}} {{mod=[[[[@{magical_attack_mod}]][MAGICAL ATTACK]]]}} {{r1=[[@{advantagetoggle}+[[@{magical_attack_mod]]-[[floor(@{affliction}/2)]] [MAGICAL ATTACK]]]}} @{charname_output}">MAGICAL ATTACK</button>
					</div>
				</div>
				<div class="hb-attacks-container">
					<div class="value">
						<input type="text" name="attr_psychic_attack_mod" title="@{psychic_attack_mod}" value="0">
					</div>
					<div class="label">
						<button class="attacks-saving-throws" type="roll" name="roll_psychic_attack" value="@{wtype}&{template:simple} {{rname=PSYCHIC ATTACK}} {{mod=[[[[@{psychic_attack_mod}]][PSYCHIC ATTACK]]]}} {{r1=[[@{advantagetoggle}+[[@{psychic_attack_mod]]-[[floor(@{affliction}/2)]] [PSYCHIC ATTACK]]]}} @{charname_output}">PSYCHIC ATTACK</button>
					</div>
				</div>
				<div class="hb-attacks-container">
					<div class="value">
						<input type="text" name="attr_social_attack_mod" title="@{social_attack_mod}" value="0">
					</div>
					<div class="label">
						<button class="attacks-saving-throws" type="roll" name="roll_social_attack" value="@{wtype}&{template:simple} {{rname=SOCIAL ATTACK}} {{mod=[[[[@{social_attack_mod}]][SOCIAL ATTACK]]]}} {{r1=[[@{advantagetoggle}+[[@{social_attack_mod]]-[[floor(@{affliction}/2)]] [SOCIAL ATTACK]]]}} @{charname_output}">SOCIAL ATTACK</button>
					</div>
				</div>
				<div class="skills-container">
                    <div class="skill">
						<select class="hiding" name="attr_alchemy_prof" title="@{alchemy_prof}" >
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_alchemy" value="@{wtype}&{template:simple} {{rname=ALCHEMY}} {{mod=[[[[@{cunning_mod}]][DEC]]]}} {{r1=[[@{alchemy_prof}@{alchemy_flat}+@{cunning_mod}-[[floor(@{affliction}/2)]][ALCHEMY+CUNNING]]]}} @{charname_output}" >Alchemy</span>
					</div>
                    <div class="skill">
						<select class="hiding" name="attr_arcana_prof" title="@{arcana_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_arcana" value="@{wtype}&{template:simple} {{rname=ARCANA}} {{mod=[[[[@{ego_mod}]][HIS]]]}} {{r1=[[@{arcana_prof}+@{arcana_flat}-[[floor(@{affliction}/2)]][ARCANA]]]}} @{charname_output}">Arcana</button>
					</div>
                    <div class="skill">
						<select class="hiding" name="attr_athletics_prof" title="@{athletics_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_athletics" value="@{wtype}&{template:simple} {{rname=ATHLETICS}} {{mod=[[[[@{physique_mod}]][ATH]]]}} {{r1=[[@{athletics_prof}+@{athletics_flat}+@{physique_mod}-[[floor(@{affliction}/2)]][SKILL+PHYSIQUE]]]}} @{charname_output}">Athletics</button>
					</div>
                    <div class="skill">
						<select class="hiding" name="attr_bureaucracy_prof" title="@{bureaucracy_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_bureaucracy" value="@{wtype}&{template:simple} {{rname=BUREAUCRACY}} {{mod=[[[[@{ego_mod}]][CUN]]]}} {{r1=[[@{bureaucracy_prof}+@{bureaucracy_flat}+@{ego_mod}-[[floor(@{affliction}/2)]][BUREAUCRACY+EGO]]]}} @{charname_output}">Bureaucracy</span></button>
					</div>
                    <div class="skill">
						<select class="hiding" name="attr_craft_prof" title="@{craft_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_craft" value="@{wtype}&{template:simple} {{rname=CRAFT}} {{mod=[[[[@{ego_mod}]][EGO]]]}} {{r1=[[@{craft_prof}+@{craft_flat}-[[floor(@{affliction}/2)]][CRAFT+EGO]]]}} @{charname_output}">Craft (<span name="attr_craft_type"></span>)</button>
				    </div>
                    <div class="skill">
						<select class="hiding" name="attr_devices_prof" title="@{devices_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_devices" value="@{wtype}&{template:simple} {{rname=DEVICES}} {{mod=[[[[@{cunning_mod}]][CUN]]]}} {{r1=[[@{devices_prof}+@{devices_flat}+@{cunning_mod}-[[floor(@{affliction}/2)]][DEVICES+CUN]]]}} @{charname_output}">Devices</button>
					</div>
                    <div class="skill">
						<select class="hiding" name="attr_healing_prof" title="@{healing_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_healing" value="@{wtype}&{template:simple} {{rname=HEALING}} {{mod=[[[[@{cunning_mod}]][CUN]]]}} {{r1=[[@{healing_prof}+@{healing_flat}-[[floor(@{affliction}/2)]][HEALING+EGO]]]}} @{charname_output}">Healing</button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_infernal_lore_prof" title="@{infernal_lore_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_infernal_lore" value="@{wtype}&{template:simple} {{rname=INFERNAL LORE}} {{mod=[[[[@{cunning_mod}]][CUN]]]}} {{r1=[[@{infernal_lore_prof}+@{infernal_lore_flat}-[[floor(@{affliction}/2)]][INFERNAL LORE]]]}} @{charname_output}">Infernal Lore</button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_perform_prof" title="@{perform_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_perform" value="@{wtype}&{template:simple} {{rname=PERFORM}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{perform_prof}+@{perform_flat}+@{charisma_mod}-[[floor(@{affliction}/2)]][PERFORM+CHA]]]}} @{charname_output}">Perform (<span name="attr_perform_type"></span>)</span></button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_poison_use_prof" title="@{poison_use_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_perform" value="@{wtype}&{template:simple} {{rname=POISON USE}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{poison_use_prof}+@{poison_use_flat}-[[floor(@{affliction}/2)]][POISON USE]]]}} @{charname_output}">Poison Use</button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_prestidigitation_prof" title="@{prestidigitation_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_prestidigitation" value="@{wtype}&{template:simple} {{rname=PRESTIDIGITATION}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{prestidigitation_prof}+@{prestidigitation_flat}-[[floor(@{affliction}/2)]][PRESTIDIGITATION]]]}} @{charname_output}">Prestidigitation</button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_profession_prof" title="@{profession_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_profession" value="@{wtype}&{template:simple} {{rname=PROFESSION}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{profession_prof}+@{profession_flat}-[[floor(@{affliction}/2)]][PROFESSION]]]}} @{charname_output}">Profession (<span name="attr_profession_type"></span>)</button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_stealth_prof" title="@{stealth_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_stealth" value="@{wtype}&{template:simple} {{rname=STEALTH}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{stealth_prof}+@{stealth_flat}-[[floor(@{affliction}/2)]][STEALTH-ARMOR]]]}} @{charname_output}">Stealth</button>
					</div>
                    <div class="skill">
						<select class="hiding"  name="attr_survival_prof" title="@{survival_prof}">
							<option value="1d6">Unskilled</option>
							<option value="1d8">Skilled</option>
							<option value="1d10">Expert</option>
							<option value="1d12">Mastered</option>
						</select>
                        <button type="roll" name="roll_survival" value="@{wtype}&{template:simple} {{rname=SURVIVAL}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{survival_prof}+@{survival_flat}-[[floor(@{affliction}/2)]][SURVIVAL]]]}} @{charname_output}">Survival (<span name="attr_survival_type"></span>)</button>
					</div>
                    <div class="label">
                        <span>SKILLS</span>
                    </div>
                </div>
            </div>
			<div class="textbox-container">
                <textarea name="attr_other_proficiencies_and_languages" style="min-height: 91px; height: 91px;"></textarea>
                <div class="label">
                    <span style="margin-top: -10px;">LANGUAGES</span>
                </div>
            </div>
        </div>
        <div class="col col2">
			<div class="hb-attacks-container" style="width: 100%; margin-top: 2px;">
                    <div class="value">
                         <input type="text" name="attr_save" title="@{save}" value="20">
                    </div>
                    <div class="label" style="width: 217px;">
                        <button class="attacks-saving-throws" type="roll" name="roll_save" value="@{wtype}&{template:simple} {{rname=SAVING THROW}} {{mod=[[[[@{save}]][SAVING THROW]]]}} {{r1=[[@{advantagetoggle}+[[@{level}]]-[[floor(@{affliction}/2)]] vs @{save} [LEVEL]]]}} @{charname_output}">SAVING THROW</button>
					</div>
            </div>
            <div class="ac-init-speed-container">
                <div class="ac" style="margin-right: 1px;">
					<input type="text" name="attr_init_pool" value="2d6">
                    <span class="label pc-ac">INITIATIVE POOL</span>
                </div>
                <div class="init">
                    <input type="text" name="attr_init_mod" value="+0">
                    <span class="label pc-ac">INITIATIVE MOD</span>
					</div>
                <div class="speed">
                    <input type="text" name="attr_movement" title="@{movement}">
                    <span class="label">SPEED</span>
                </div>
            </div>
			            <div class="hdice-dsaves-container" style="width: 242px;">
                <div class="subcontainer">
					<div class="ac" style="margin-right: 1px;">
					<input type="text" name="attr_pac" title="@{pac}" value="floor((@{physique}+@{cunning})/2+@{globalpacmod}+@{racialpacmod})" disabled="true">
                    <span class="label pc-ac">PAC</span>
					</div>
				</div>
                <div class="subcontainer" style="float: right;">
					<div class="ac" style="margin-right: 1px;">
						<input type="text" name="attr_mac" title="@{mac}" value="floor((@{ego}+@{charisma})/2+@{globalmacmod}+@{racialmacmod})" disabled="true">
						<span class="label pc-ac">MAC</span>
					</div>
				</div>
            </div>
			<div class="hdice-dsaves-container" style="width: 242px;">
                <div class="subcontainer">
					<div class="ac" style="margin-right: 1px;">
						<div class="top">
							<span>Max</span>
							<input type="text" name="attr_physical_hp_max" title="@{physical_hp_max}" value="0">
						</div>
						<input type="number" name="attr_physical_hp" title="@{physical_hp}" value="0">
						<span class="label">PHYSICAL HIT POINTS</span>
					</div>
				</div>
                <div class="subcontainer" style="float: right;">
					<div class="ac" style="margin-right: 1px;">
						<div class="top">
							<span>Max</span>
							<input type="text" name="attr_mental_hp_max" title="@{mental_hp_max}" value="0">
						</div>
						<input type="number" name="attr_mental_hp" title="@{mental_hp}" value="0">
						<span class="label">MENTAL HIT POINTS</span>
					</div>
				</div>
            </div>
			<div class="hp" style="height: 56px;">
                <input type="number" name="attr_hp_temp" title="@{stress}" value="0">
                <span class="label" >STRESS</span>
            </div>
            <div class="hdice-dsaves-container" style="width: 242px;">
                <div class="subcontainer">
					<div class="ac" style="margin-right: 1px;">
						<input class="attr" type="text" name="attr_physical_hit_die" title="@{physical_hit_die}">
						<button type="roll" name="roll_physical_struggle" value="@{wtype}&{template:simple} {{rname=PHYSICAL STRUGGLE}} {{mod=[[[[@{physical_hit_die}]][PHYSICAL STRUGGLE]]]}} {{r1=[[@{level}*(@{physical_hit_die}+@{attr_size})+@{previous_level}*@{previous_physical_hd}(@{previous_physical_hd}+@{attr_size})-[[floor(@{affliction}/2)]][PHYSICAL HIT DIE POOL + SIZE]]]}} @{charname_output}">PHYSICAL HIT DIE</button>
					</div>
				</div>
                <div class="subcontainer" style="float: right;">
					<div class="ac" style="margin-right: 1px;">
						<input class="attr" type="text" name="attr_mental_hit_die" title="@{mental_hit_die}">
						<button type="roll" name="roll_psychic_struggle" value="@{wtype}&{template:simple} {{rname=PSYCHIC STRUGGLE}} {{mod=[[[[@{mental_hit_die}]][PSYCHIC STRUGGLE]]]}} {{r1=[[@{level}*@{mental_hit_die}+@{previous_level}*@{previous_mental_hd}-[[floor(@{affliction}/2)]][MENTAL HIT DIE POOL + SIZE]]]}} @{charname_output}">MENTAL HIT DIE</button>
					</div>
				</div>
            </div>
            <input type="hidden" class="ammoflag" name="attr_ammoflag">
<div class="attacks" style="position: relative;">
                <div class="top">
                    <span class="label" style="width: 95px;">NAME</span>
                    <span class="label" style="width: 25px;">ATK</span>
                    <span class="label" style="width: 95px;">DAMAGE/TYPE</span>
                </div>
                <fieldset class="repeating_attack">
                    <div class="attack">
                        <input type="hidden" name="attr_updateflag">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_atkname_base">
                            </div>
                            <div class="row">
                                <input type="checkbox" name="attr_atkflag" value="{{attack=1}}" checked="checked">
                                <span>ATTACK:</span>
                                <select name="attr_atkattr_base">
                                    <option value="@{physical_attack_mod}">PHYSICAL</option>
                                    <option value="@{magical_attack_mod}">MAGICAL</option>
                                    <option value="@{psychic_attack_mod}">PSYCHIC</option>
                                    <option value="@{social_attack_mod}">SOCIAL</option>
                                    <option value="0" selected="selected">-</option>
                                </select>
                                <span>+</span>
                                <input type="text" class="num" name="attr_atkmod" placeholder="0">
                                <span>+</span>
                                <input type="checkbox" name="attr_atkprofflag" value="(@{pb})" checked="checked" style="margin-left: 3px;">
                                <span>PROFICIENT</span>
                            </div>
                            <div class="row">
                                <span style="margin-left: 17px;">RANGE:</span>
                                <input type="text" name="attr_atkrange" placeholder="Self (60-foot cone)" style="width: 170px;">
                            </div>
                            <div class="row">
                                <span style="margin-left: 17px;">MAGIC BONUS:</span>
                                <input type="text" class="num" name="attr_atkmagic" placeholder="0">
                                <span>CRIT RANGE:</span>
                                <input type="text" class="num" name="attr_atkcritrange" value="20" placeholder="20">
                            </div>
                            <div class="row">
                                <input type="checkbox" name="attr_dmgflag" value="{{damage=1}} {{dmg1flag=1}}" checked="checked">
                                <span>DAMAGE:</span>
                                <input type="text" name="attr_dmgbase" placeholder="1d6" style="width: 50px;">
                                <span>+</span>
                                <select name="attr_dmgattr">
                                    <option value="@{strength_mod}" data-i18n="str-u">STR</option>
                                    <option value="@{dexterity_mod}" data-i18n="dex-u">DEX</option>
                                    <option value="@{constitution_mod}" data-i18n="con-u">CON</option>
                                    <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                                    <option value="@{wisdom_mod}" data-i18n="wis-u">WIS</option>
                                    <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                                    <option value="0" selected="selected">-</option>
                                </select>
                                <span>+</span>
                                <input type="text" class="num" name="attr_dmgmod" placeholder="0">
                            </div>
                            <div class="row">
                                <span style="margin-left: 17px;">TYPE:</span>
                                <input type="text" name="attr_dmgtype" placeholder="Slashing" style="width: 50px;">
                                <span>CRIT:</span>
                                <input type="text" name="attr_dmgcustcrit" placeholder="1d6" style="width: 80px;">
                            </div>
                            <div class="row">
                                <input type="checkbox" name="attr_dmg2flag" value="{{damage=1}} {{dmg2flag=1}}">
                                <span>DAMAGE2:</span>
                                <input type="text" name="attr_dmg2base" placeholder="1d6" style="width: 50px;">
                                <span>+</span>
                                <select name="attr_dmg2attr">
                                    <option value="@{strength_mod}" selected="selected" data-i18n="str-u">STR</option>
                                    <option value="@{dexterity_mod}" data-i18n="dex-u">DEX</option>
                                    <option value="@{constitution_mod}" data-i18n="con-u">CON</option>
                                    <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                                    <option value="@{wisdom_mod}" data-i18n="wis-u">WIS</option>
                                    <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                                    <option value="0">-</option>
                                </select>
                                <span>+</span>
                                <input type="text" class="num" name="attr_dmg2mod" placeholder="0">
                            </div>
                            <div class="row">
                                <span style="margin-left: 17px;">TYPE:</span>
                                <input type="text" name="attr_dmg2type" placeholder="Slashing" style="width: 50px;">
                                <span>CRIT:</span>
                                <input type="text" name="attr_dmg2custcrit" placeholder="1d6" style="width: 80px;">
                            </div>
                            <div class="row">
                                <input type="checkbox" name="attr_saveflag" value="{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}">
                                <span>SAVING THROW:</span>
                                <select name="attr_saveattr">
                                    <option value="Strength" selected="selected" data-i18n="str-u">STR</option>
                                    <option value="Dexterity" data-i18n="dex-u">DEX</option>
                                    <option value="Constitution" data-i18n="con-u">CON</option>
                                    <option value="Intelligence" data-i18n="int-u">INT</option>
                                    <option value="Wisdom" data-i18n="wis-u">WIS</option>
                                    <option value="Charisma" data-i18n="cha-u">CHA</option>
                                </select>
                                <span>VS DC:</span>
                                <select name="attr_savedc">
                                    <option value="(@{spell_save_dc})" selected="selected" data-i18n="spell-u">SPELL</option>
                                    <option value="(@{strength_mod}+8+@{pb})" data-i18n="str-u">STR</option>
                                    <option value="(@{dexterity_mod}+8+@{pb})" data-i18n="dex-u">DEX</option>
                                    <option value="(@{constitution_mod}+8+@{pb})" data-i18n="con-u">CON</option>
                                    <option value="(@{intelligence_mod}+8+@{pb})" data-i18n="int-u">INT</option>
                                    <option value="(@{wisdom_mod}+8+@{pb})" data-i18n="wis-u">WIS</option>
                                    <option value="(@{charisma_mod}+8+@{pb})" data-i18n="cha-u">CHA</option>
                                    <option value="(@{saveflat})" data-i18n="flat-u">FLAT</option>
                                </select>
                                <input class="flatflag" type="hidden" name="attr_flatflag">
                                <input class="num flat" type="text" name="attr_saveflat" placeholder="10">
                            </div>
                            <div class="row">
                                <span>SAVE EFFECT:</span>
                                <input type="text" name="attr_saveeffect" placeholder="half damage" style="width: 160px;">
                            </div>
                            <div class="row ammo">
                                <span>AMMUNITION:</span>
                                <input type="text" name="attr_ammo" placeholder="Arrows" style="width: 160px;">
                            </div>
                            <div class="row">
                                <span>DESCRIPTION:</span>
                                <textarea name="attr_atk_desc" placeholder="Up to 2 creatures within 5 feet"></textarea>
                            </div>
                        </div>
                        <div class="display">
                            <button type="roll" name="roll_attack" value="@{rollbase}">
                                <input type="text" name="attr_atkname" style="width: 95px;" value="">
                                <input type="text" name="attr_atkbonus" style="width: 35px; text-align: center;" value="">
                                <input type="text" name="attr_atkdmgtype" style="width: 95px;" value="">
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="attr_hidden_r1base">
                    <input type="hidden" name="attr_hidden_r2base">
                    <input type="hidden" name="attr_hidden_atkbonus">
                    <input type="hidden" name="attr_hidden_dmg1">
                    <input type="hidden" name="attr_hidden_dmg2">
                    <input type="hidden" name="attr_hidden_dmg1type">
                    <input type="hidden" name="attr_hidden_dmg2type">
                    <input type="hidden" name="attr_hidden_crit1">
                    <input type="hidden" name="attr_hidden_crit2">
                    <input type="hidden" name="attr_hldmg">
                    <input type="hidden" name="attr_spelllevel">
                    <input type="hidden" name="attr_rollbase">
                    <button type="roll" name="roll_attack_dmg" style="display: none;" value="@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[@{hidden_dmg1}]]}} {{dmg1type=@{hidden_dmg1type}}} @{dmg2flag} {{dmg2=[[@{hidden_dmg2}]]}} {{dmg2type=@{hidden_dmg2type}}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} @{spelllevel} @{charname_output}"></button>
                    <button type="roll" name="roll_attack_crit" style="display: none;" value="@{wtype}&{template:dmg} {{crit=1}} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[@{hidden_dmg1}]]}} {{dmg1type=@{hidden_dmg1type}}} @{dmg2flag} {{dmg2=[[@{hidden_dmg2}]]}} {{dmg2type=@{hidden_dmg2type}}} {{crit1=[[@{hidden_crit1}]]}} {{crit2=[[@{hidden_crit2}]]}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} @{spelllevel} @{charname_output}"></button>
                    <input type="hidden" name="attr_itemid">
                    <input type="hidden" name="attr_spellid">
                </fieldset>
                <span class="label" style="margin-top: 0px; position: absolute; bottom: 0px;">ATTACKS & SPELLCASTING</span>
            </div>
            <div class="equipment">
                <div class="money">
					<div class="coin">
                        <span class="label">CB</span>
                        <input type="text" name="attr_cb" value="0" title="@{cb}">
                    </div>
                    <div class="coin">
                        <span class="label">CP</span>
                        <input type="text" name="attr_cp" value="0" title="@{cp}">
                    </div>
					<div class="coin">
                        <span class="label">CS</span>
                        <input type="text" name="attr_cs" value="0" title="@{cs}">
                    </div>
                    <div class="coin">
                        <span class="label">SP</span>
                        <input type="text" name="attr_sp" value="0" title="@{sp}">
                    </div>
                    <div class="coin">
                        <span class="label">GC</span>
                        <input type="text" name="attr_gc" value="0" title="@{gc}">
                    </div>
                    <div class="coin">
                        <span class="label">PC</span>
                        <input type="text" name="attr_pc" value="0" title="@{pc}">
                    </div>
                </div>
                <input type="hidden" class="inventoryflag" name="attr_inventoryflag" value="complex">
                <textarea class="simple" name="attr_equipment"></textarea>
                <div class="complex">
                    <input type="hidden" class="warningflag" name="attr_armorwarningflag">
                    <div class="warning">
                        <span>
                            <input type="checkbox" name="attr_armorwarning" value="hide">
                            WARNING - MULTIPLE SETS OF ARMOR OR SHIELDS HAVE BEEN ADDED AND AC IS NOT CORRECTLY CALCULATED. UNEQUIP THE ARMOR PIECE FROM THE ITEM DETAILS.
                        </span>
                    </div>
                    <div class="header" style="height: auto;">
                        <span class="pictos" style="width: 25px; font-size: 15px;">*</span>
                        <span style="width: 100px; text-align: left;">ITEM NAME</SPAN>
                        <span style="width: 25px;"><img src="http://i.imgur.com/3OxOqmb.png" style="width: 15px; margin-bottom: -3px;"></span>
                    </div>
                    <fieldset class="repeating_inventory">
                        <input type="hidden" class="equippedflag" name="attr_equippedflag">
                        <div class="item compendium-drop-target">
                            <input class="itemcount" type="text" name="attr_itemcount" value="1">
                            <input class="name" type="text" name="attr_itemname">
							<select class="weight" name="attr_itemweight">
								<option value="0.05">Bundle</option>
								<option value="1" selected="selected">Light</option>
								<option value="2">Encumbering</option>
								<option value="4">Heavy</option>
								<option value="10">Unwieldy</option>
							</select>
                            <input class="inventorysubflag" type="checkbox" name="attr_inventorysubflag"><span>i</span>
                            <div class="subitem">
                                <input class="equipped" type="checkbox" name="attr_equipped" value="1" checked="checked">
                                <span class="equippedlabel">EQUIPPED</span>
                                <input class="equipped" type="checkbox" name="attr_useasresource" value="1">
                                <span class="equippedlabel">USE AS A RESOURCE</span>
                                <span class="label">PROP:</span>
                                <input class="subfield" type="text" name="attr_itemproperties" accept="Properties">
                                <span class="label">MODS:</span>
                                <input class="subfield" type="text" name="attr_itemmodifiers" accept="Modifiers">
                                <textarea class="subtextarea" name="attr_itemcontent" accept="Content"></textarea>
                            </div>
                            <input type="hidden" name="attr_itemtype" accept="Item Type">
                            <input type="hidden" name="attr_itemdamage" accept="Damage">
                            <input type="hidden" name="attr_itemdamagetype" accept="Damage Type">
                            <input type="hidden" name="attr_itemrange" accept="Range">
                            <input type="hidden" name="attr_itemac" accept="AC">
                            <input type="hidden" name="attr_itemattackid">
                            <input type="hidden" name="attr_itemresourceid">
                        </div>
                    </fieldset>
                    <div class="weighttotal">
                        <span class="label">ITEM SLOTS REMAINING</span>
                        <input type="text" name="attr_itemslots" value="0">
                        <input type="hidden" class="encumberance" name="attr_encumberance">
                        <span class="encumb immobile">IMMOBILE</span>
                        <span class="encumb heavily">HEAVILY ENCUMBERED</span>
                        <span class="encumb encumbered">MODERATELY ENCUMBERED</span>
						<span class="encumb lightly">LIGHTLY ENCUMBERED</span>
                        <span class="encumb over">OVER CARRYING CAPACITY</span>
                    </div>
                </div>
                <span class="label" style="margin-top: 0px; position: absolute; bottom: 0px;">EQUIPMENT</span>
            </div>	
        </div>
        <div class="col col3">
            <div class="resources">
                <div class="hdice-dsaves-container" style="width: 246px; margin-top: 10px;">
                    <div class="subcontainer" style="height: 64px; width: 119px;">
                        <div class="top">
                            <span>Total</span>
                            <input type="text" name="attr_resource_max" title="@{resource_max}">
                        </div>
                        <input type="number" name="attr_resource" title="@{resource}" style="margin-bottom: -6px;">
                        <input type="text" class="label" name="attrresource_name" title="@{resource_name}" placeholder="RESOURCE">
                    </div>
                    <div class="subcontainer" style="height: 64px; width: 119px; float: right;">
                        <div class="top">
                            <span>Total</span>
                            <input type="text" name="attr_other_resource_max" title="@{other_resource_max}">
                        </div>
                        <input type="number" name="attr_other_resource" title="@{other_resource}" style="margin-bottom: -6px;">
                        <input type="text" class="label" name="attr_other_resource_name" title="@{other_resource_name}" placeholder="RESOURCE">
                        <input type="hidden" name="attr_other_resource_itemid">
                    </div>
                </div>
                <fieldset class="repeating_resource">
                    <div class="hdice-dsaves-container" style="width: 246px; margin-top: 10px;">
                        <div class="subcontainer" style="height: 64px; width: 119px;">
                            <div class="top">
                                <span>Total</span>
                                <input type="text" name="attr_resource_left_max" title="@{repeating_resource_left_max}">
                            </div>
                            <input type="number" name="attr_resource_left" title="@{repeating_resource_left}" style="margin-bottom: -6px;">
                            <input type="text" class="label" name="attr_resource_left_name" title="@{repeating_resource_left_name}" placeholder="RESOURCE">
                            <input type="hidden" name="attr_resource_left_itemid">
                        </div>
                        <div class="subcontainer" style="height: 64px; width: 119px;">
                            <div class="top">
                                <span>Total</span>
                                <input type="text" name="attr_resource_right_max" title="@{repeating_resource_right_max}">
                            </div>
                            <input type="number" name="attr_resource_right" title="@{repeating_resource_right}" style="margin-bottom: -6px;">
                            <input type="text" class="label" name="attr_resource_right_name" title="@{repeating_resource_right_name}" placeholder="RESOURCE">
                            <input type="hidden" name="attr_resource_right_itemid">
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="textbox" style="">
                <textarea name="attr_features_and_traits" style="min-height: 461px; height: 461px;"></textarea>
                <span class="label" >SPECIAL ABILITIES</span>
            </div>
        </div>
        
    </div>
</div>
    
<div class="page spells">
    <div class="header">
        <div class="name-container">
            <img src="http://i.imgur.com/ZgULBCp.png" style="padding-bottom: 5px;">
            <input type="text" name="attr_character_name" style="width: 100%;">
            <span class="label">CHARACTER NAME</span>
        </div>
        <div class="header-info">
            <div class="part">
                <input type="text" name="attr_spell pool" value="0">
                <span class="label">SPELL POOL</span>
            </div>
            <div class="part">
                <input type="text" name="attr_power_points" value="0">
                <span class="label">POWER POINTS</span>
            </div>
        </div>
    </div>
    <div class="body">
        <div class="col col1">
            <div class="spell-level">
                <div class="cantrips">
                    <span class="label">RITUALS</span>
                </div>
            </div>
            <div class="spell-container">
                <fieldset class="repeating_spell-cantrip">
                    <div class="spell compendium-drop-target">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_spellname_base">
                            </div>
                            <div class="row">
                                <span>REQUIRES:</span>
                                <input type="text" name="attr_spellduration">
                            </div>
                            <div class="row">
                                <span>OUTPUT:</span>
                                <select name="attr_spelloutput">
                                    <option value="SPELLCARD">SPELLCARD</option>
                                    <option value="ATTACK">ATTACK</option>
                                </select>
                            </div>
                            <input type="hidden" class="spellattackinfoflag" name="attr_spellattackinfoflag">
                            <div class="row">
                                <span>DESCRIPTION:</span>
                            </div>
                            <input type="hidden" name="attr_spellcontent" accept="Content">
                            <div class="row">
                                <textarea name="attr_spelldescription"></textarea>
                            </div>
                            <input type="hidden" name="attr_spellattackid">
                            <input type="hidden" name="attr_spelllevel" accept="Level">
                            <input type="hidden" name="attr_spell_updateflag">
                        </div>
                        <div class="display">
                            <input type="hidden" name="attr_rollcontent" value="@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}}  {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}">
                            <button class="spellcard" type="roll" name="roll_spell" value="@{rollcontent}">
                                <input type="text" name="attr_spellname" style="width: 225px; margin-left: 3px;" value="">
                            </button>
                        </div>
                    </div>
                </fieldset>
            </div>
            

        </div>
        <div class="col col2">
        
 <div class="spell-level">
                <div class="cantrips">
                    <span class="label">MINOR SPELLS</span>
                </div>
            </div>
            <div class="spell-container">
                <fieldset class="repeating_spell-1">
                    <div class="spell compendium-drop-target">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_spellname_base" accept="Name">
                                <input type="checkbox" name="attr_spellprepared" value="1" checked="checked">
                                <span>LOST</span>
                            </div>
                            <div class="row">
                                <span>SCHOOL:</span>
                                <select name="attr_spellschool" accept="School">
                                    <option value="diabolic power">Diabolic Power</option>
                                    <option value="demonic power" >Demonic Power</option>
                                    <option value="arcana">Arcana</option>
                                    <option value="enchantment">Enchantment</option>
                                    <option value="fleshcrafting">Fleshcrafting</option>
                                    <option value="law">Law</option>
                                    <option value="shadow">Shadow</option>
                                    <option value="transmutation">Transmutation</option>
                                </select>
                            </div>
                            <div class="row">
                                <span>RANGE:</span>
                                <input type="text" name="attr_spellrange" accept="Range">
                            </div>
                            <div class="row">
                                <input type="hidden" name="attr_spellconcentrationflag" accept="Concentration">
                                <input type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}">
                                <span>CONCENTRATION</span>
                            </div>
                            <div class="row">
                                <span>DURATION:</span>
                                <input type="text" name="attr_spellduration" accept="Duration">
                            </div>
                            <div class="row">
                                <span>OUTPUT:</span>
                                <select name="attr_spelloutput">
                                    <option value="SPELLCARD">SPELLCARD</option>
                                    <option value="ATTACK">ATTACK</option>
                                </select>
                            </div>
                            <input type="hidden" class="spellattackinfoflag" name="attr_spellattackinfoflag">
                            <div class="spellattackinfo">
                                <div class="row">
                                    <span>SPELL ATTACK:</span>
                                    <select name="attr_spellattack" accept="Spell Attack">
                                        <option>None</option>
                                        <option>Melee</option>
                                        <option>Ranged</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <span>DAMAGE:</span>
                                    <input type="text" name="attr_spelldamage" accept="Damage" style="width: 50px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype" accept="Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>DAMAGE2:</span>
                                    <input type="text" name="attr_spelldamage2" accept="Secondary Damage" style="width: 45px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype2" accept="Secondary Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>HEALING:</span>
                                    <input type="text" name="attr_spellhealing" accept="Healing" style="width: 45px;">
                                </div>
                                <div class="row">
                                    <input type="checkbox" name="attr_spelldmgmod" value="Yes" accept="Add Casting Modifier">
                                    <span>ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                                </div>
                            </div>
                            <div class="row">
                                <span>DESCRIPTION:</span>
                            </div>
                            <input type="hidden" name="attr_spellcontent" accept="Content">
                            <div class="row">
                                <textarea name="attr_spelldescription"></textarea>
                            </div>
                            <input type="hidden" name="attr_spellattackid">
                            <input type="hidden" name="attr_spelllevel" accept="Level">
                            <input type="hidden" name="attr_spell_updateflag">
                        </div>
                        <div class="display">
                            <input type="hidden" name="attr_rollcontent" value="@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}}  {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}">
                            <button class="spellcard" type="roll" name="roll_spell" value="@{rollcontent}">
                                <input type="hidden" name="attr_prep" value=""><span class="prep"></span>
                                <input type="text" name="attr_spellname" style="width: 225px; margin-left: 13px;" value="">
                            </button>
                        </div>
                    </div>
                </fieldset>
            </div>
            
            <div class="spell-level">
                <div class="cantrips">
                    <span class="label">MAJOR SPELLS</span>
                </div>
            </div>
            <div class="spell-container">
                <fieldset class="repeating_spell-2">
                    <div class="spell compendium-drop-target">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_spellname_base" accept="Name">
                                <input type="checkbox" name="attr_spellprepared" value="1" checked="checked">
                                <span>LOST</span>
                            </div>
                            <div class="row">
                                <span>SCHOOL:</span>
                                <select name="attr_spellschool" accept="School">
                                    <option value="diabolic power">Diabolic Power</option>
                                    <option value="demonic power" >Demonic Power</option>
                                    <option value="arcana">Arcana</option>
                                    <option value="enchantment">Enchantment</option>
                                    <option value="fleshcrafting">Fleshcrafting</option>
                                    <option value="law">Law</option>
                                    <option value="shadow">Shadow</option>
                                    <option value="transmutation">Transmutation</option>
                                </select>
                            </div>
                            <div class="row">
                                <span>RANGE:</span>
                                <input type="text" name="attr_spellrange" accept="Range">
                            </div>
                            <div class="row">
                                <input type="hidden" name="attr_spellconcentrationflag" accept="Concentration">
                                <input type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}">
                                <span>CONCENTRATION</span>
                            </div>
                            <div class="row">
                                <span>DURATION:</span>
                                <input type="text" name="attr_spellduration" accept="Duration">
                            </div>
                            <div class="row">
                                <span>OUTPUT:</span>
                                <select name="attr_spelloutput">
                                    <option value="SPELLCARD">SPELLCARD</option>
                                    <option value="ATTACK">ATTACK</option>
                                </select>
                            </div>
                            <input type="hidden" class="spellattackinfoflag" name="attr_spellattackinfoflag">
                            <div class="spellattackinfo">
                                <div class="row">
                                    <span>SPELL ATTACK:</span>
                                    <select name="attr_spellattack" accept="Spell Attack">
                                        <option>None</option>
                                        <option>Melee</option>
                                        <option>Ranged</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <span>DAMAGE:</span>
                                    <input type="text" name="attr_spelldamage" accept="Damage" style="width: 50px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype" accept="Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>DAMAGE2:</span>
                                    <input type="text" name="attr_spelldamage2" accept="Secondary Damage" style="width: 45px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype2" accept="Secondary Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>HEALING:</span>
                                    <input type="text" name="attr_spellhealing" accept="Healing" style="width: 45px;">
                                </div>
                                <div class="row">
                                    <input type="checkbox" name="attr_spelldmgmod" value="Yes" accept="Add Casting Modifier">
                                    <span>ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                                </div>
                            </div>
                            <div class="row">
                                <span>DESCRIPTION:</span>
                            </div>
                            <input type="hidden" name="attr_spellcontent" accept="Content">
                            <div class="row">
                                <textarea name="attr_spelldescription"></textarea>
                            </div>
                            <input type="hidden" name="attr_spellattackid">
                            <input type="hidden" name="attr_spelllevel" accept="Level">
                            <input type="hidden" name="attr_spell_updateflag">
                        </div>
                        <div class="display">
                            <input type="hidden" name="attr_rollcontent" value="@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}}  {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}">
                            <button class="spellcard" type="roll" name="roll_spell" value="@{rollcontent}">
                                <input type="hidden" name="attr_prep" value=""><span class="prep"></span>
                                <input type="text" name="attr_spellname" style="width: 225px; margin-left: 13px;" value="">
                            </button>
                        </div>
                    </div>
                </fieldset>
            </div>
     
            <div class="spell-level">
                <div class="cantrips">
                    <span class="label">GRAND SPELLS</span>
                </div>
            </div>
            <div class="spell-container">
                <fieldset class="repeating_spell-3">
                    <div class="spell compendium-drop-target">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_spellname_base" accept="Name">
                                <input type="checkbox" name="attr_spellprepared" value="1" checked="checked">
                                <span>LOST</span>
                            </div>
                            <div class="row">
                                <span>SCHOOL:</span>
                                <select name="attr_spellschool" accept="School">
                                    <option value="diabolic power">Diabolic Power</option>
                                    <option value="demonic power" >Demonic Power</option>
                                    <option value="arcana">Arcana</option>
                                    <option value="enchantment">Enchantment</option>
                                    <option value="fleshcrafting">Fleshcrafting</option>
                                    <option value="law">Law</option>
                                    <option value="shadow">Shadow</option>
                                    <option value="transmutation">Transmutation</option>
                                </select>
                            </div>
                            <div class="row">
                                <span>RANGE:</span>
                                <input type="text" name="attr_spellrange" accept="Range">
                            </div>
                            <div class="row">
                                <input type="hidden" name="attr_spellconcentrationflag" accept="Concentration">
                                <input type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}">
                                <span>CONCENTRATION</span>
                            </div>
                            <div class="row">
                                <span>DURATION:</span>
                                <input type="text" name="attr_spellduration" accept="Duration">
                            </div>
                            <div class="row">
                                <span>OUTPUT:</span>
                                <select name="attr_spelloutput">
                                    <option value="SPELLCARD">SPELLCARD</option>
                                    <option value="ATTACK">ATTACK</option>
                                </select>
                            </div>
                            <input type="hidden" class="spellattackinfoflag" name="attr_spellattackinfoflag">
                            <div class="spellattackinfo">
                                <div class="row">
                                    <span>SPELL ATTACK:</span>
                                    <select name="attr_spellattack" accept="Spell Attack">
                                        <option>None</option>
                                        <option>Melee</option>
                                        <option>Ranged</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <span>DAMAGE:</span>
                                    <input type="text" name="attr_spelldamage" accept="Damage" style="width: 50px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype" accept="Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>DAMAGE2:</span>
                                    <input type="text" name="attr_spelldamage2" accept="Secondary Damage" style="width: 45px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype2" accept="Secondary Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>HEALING:</span>
                                    <input type="text" name="attr_spellhealing" accept="Healing" style="width: 45px;">
                                </div>
                                <div class="row">
                                    <input type="checkbox" name="attr_spelldmgmod" value="Yes" accept="Add Casting Modifier">
                                    <span>ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                                </div>
                            </div>
                            <div class="row">
                                <span>DESCRIPTION:</span>
                            </div>
                            <input type="hidden" name="attr_spellcontent" accept="Content">
                            <div class="row">
                                <textarea name="attr_spelldescription"></textarea>
                            </div>
                            <input type="hidden" name="attr_spellattackid">
                            <input type="hidden" name="attr_spelllevel" accept="Level">
                            <input type="hidden" name="attr_spell_updateflag">
                        </div>
                        <div class="display">
                            <input type="hidden" name="attr_rollcontent" value="@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}}  {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}">
                            <button class="spellcard" type="roll" name="roll_spell" value="@{rollcontent}">
                                <input type="hidden" name="attr_prep" value=""><span class="prep"></span>
                                <input type="text" name="attr_spellname" style="width: 225px; margin-left: 13px;" value="">
                            </button>
                        </div>
                    </div>
               </fieldset>
            </div>
            
        </div>
        <div class="col col3">
        
            <div class="spell-level">
                <div class="cantrips">
                    <span class="label">DRUIDIC SPELLS</span>
                </div>
            </div>
            <div class="spell-container">
                <fieldset class="repeating_spell-4">
					<div class="spell compendium-drop-target">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_spellname_base" accept="Name">
                                <input type="checkbox" name="attr_spellprepared" value="1" checked="checked">
                                <span>LOST</span>
                            </div>
                            <div class="row">
                                <span>PATH:</span>
                                <select name="attr_spellschool" accept="School">
                                    <option value="earth">Earth</option>
                                    <option value="dust" >Dust</option>
                                    <option value="fire">Fire</option>
                                    <option value="pain">Pain</option>
                                </select>
                            </div>
                            <div class="row">
                                <span>RANGE:</span>
                                <input type="text" name="attr_spellrange" accept="Range">
                            </div>
                            <div class="row">
                                <input type="hidden" name="attr_spellconcentrationflag" accept="Concentration">
                                <input type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}">
                                <span>CONCENTRATION</span>
                            </div>
                            <div class="row">
                                <span>DURATION:</span>
                                <input type="text" name="attr_spellduration" accept="Duration">
                            </div>
                            <div class="row">
                                <span>OUTPUT:</span>
                                <select name="attr_spelloutput">
                                    <option value="SPELLCARD">SPELLCARD</option>
                                    <option value="ATTACK">ATTACK</option>
                                </select>
                            </div>
                            <input type="hidden" class="spellattackinfoflag" name="attr_spellattackinfoflag">
                            <div class="spellattackinfo">
                                <div class="row">
                                    <span>SPELL ATTACK:</span>
                                    <select name="attr_spellattack" accept="Spell Attack">
                                        <option>None</option>
                                        <option>Melee</option>
                                        <option>Ranged</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <span>DAMAGE:</span>
                                    <input type="text" name="attr_spelldamage" accept="Damage" style="width: 50px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype" accept="Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>DAMAGE2:</span>
                                    <input type="text" name="attr_spelldamage2" accept="Secondary Damage" style="width: 45px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype2" accept="Secondary Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>HEALING:</span>
                                    <input type="text" name="attr_spellhealing" accept="Healing" style="width: 45px;">
                                </div>
                                <div class="row">
                                    <input type="checkbox" name="attr_spelldmgmod" value="Yes" accept="Add Casting Modifier">
                                    <span>ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                                </div>
                            </div>
                            <div class="row">
                                <span>DESCRIPTION:</span>
                            </div>
                            <input type="hidden" name="attr_spellcontent" accept="Content">
                            <div class="row">
                                <textarea name="attr_spelldescription"></textarea>
                            </div>
                            <input type="hidden" name="attr_spellattackid">
                            <input type="hidden" name="attr_spelllevel" accept="Level">
                            <input type="hidden" name="attr_spell_updateflag">
                        </div>
                        <div class="display">
                            <input type="hidden" name="attr_rollcontent" value="@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}}  {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}">
                            <button class="spellcard" type="roll" name="roll_spell" value="@{rollcontent}">
                                <input type="hidden" name="attr_prep" value=""><span class="prep"></span>
                                <input type="text" name="attr_spellname" style="width: 225px; margin-left: 13px;" value="">
                            </button>
                        </div>
                    </div>
               </fieldset>
            </div>
            
            <div class="spell-level">
                <div class="cantrips">
                    <span class="label">PSIONIC ATTACK MODES</span>
                </div>
            </div>
            <div class="spell-container">
                <fieldset class="repeating_spell-5">
					<div class="spell compendium-drop-target">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                        <div class="options">
                            <div class="row">
                                <span>NAME:</span>
                                <input type="text" name="attr_spellname_base" accept="Name">
                            </div>
                            <div class="row">
                                <span>DURATION:</span>
                                <input type="text" name="attr_spellduration" accept="Duration">
                            </div>
                            <div class="row">
                                <span>OUTPUT:</span>
                                <select name="attr_spelloutput">
                                    <option value="SPELLCARD">SPELLCARD</option>
                                    <option value="ATTACK" selected="selected">ATTACK</option>
                                </select>
                            </div>
                            <input type="hidden" class="spellattackinfoflag" name="attr_spellattackinfoflag">
                            <div class="spellattackinfo">
                                <div class="row">
                                    <span>SPELL ATTACK:</span>
                                    <select name="attr_spellattack" accept="Spell Attack">
                                        <option>None</option>
                                        <option>Melee</option>
                                        <option>Ranged</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <span>DAMAGE:</span>
                                    <input type="text" name="attr_spelldamage" accept="Damage" style="width: 50px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype" accept="Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>DAMAGE2:</span>
                                    <input type="text" name="attr_spelldamage2" accept="Secondary Damage" style="width: 45px;">
                                    <span>TYPE:</span>
                                    <input type="text" name="attr_spelldamagetype2" accept="Secondary Damage Type" style="width: 103px;">
                                </div>
                                <div class="row">
                                    <span>HEALING:</span>
                                    <input type="text" name="attr_spellhealing" accept="Healing" style="width: 45px;">
                                </div>
                                <div class="row">
                                    <input type="checkbox" name="attr_spelldmgmod" value="Yes" accept="Add Casting Modifier">
                                    <span>ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                                </div>
                            </div>
                            <div class="row">
                                <span>DESCRIPTION:</span>
                            </div>
                            <input type="hidden" name="attr_spellcontent" accept="Content">
                            <div class="row">
                                <textarea name="attr_spelldescription"></textarea>
                            </div>
                            <input type="hidden" name="attr_spellattackid">
                            <input type="hidden" name="attr_spelllevel" accept="Level">
                            <input type="hidden" name="attr_spell_updateflag">
                        </div>
                        <div class="display">
                            <input type="hidden" name="attr_rollcontent" value="@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}}  {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}">
                            <button class="spellcard" type="roll" name="roll_spell" value="@{rollcontent}">
                                <input type="text" name="attr_spellname" style="width: 225px; margin-left: 13px;" value="">
                            </button>
                        </div>
                    </div>
               </fieldset>
            </fieldset>
            </div>
            
        </div>
    </div>
</div>

<div class="page options">
    <div class="header">
        <div class="name-container">
            <img src="http://i.imgur.com/ZgULBCp.png" style="padding-bottom: 5px;">
            <input type="text" name="attr_character_name" style="width: 100%;">
            <span class="label">CHARACTER NAME</span>
        </div>
        <div class="header-info">
            <div class="top">
                <div class="hlabel-container">
                    <input class="flag" type="hidden" name="attr_customclass_flag" value="0">
                    <input class="showing" type="text" name="attr_cust_class" value="@{cust_classname}" disabled="true" style="width: 64px; height: 28px; padding-top: 10px;">
                    <select class="hiding" name="attr_class" style="width: 64px;">
                        <option value="Thug">Thug</option>
                        <option value="Inheritor">Inheritor</option>
                        <option value="Inquisitor">Inquisitor</option>
                        <option value="Druid">Druid</option>
                        <option value="Heavy Knight">Heavy Knight</option>
                        <option value="Mystic">Mystic</option>
                        <option value="Paladin">Paladin</option>
                        <option value="Outrider">Outrider</option>
                        <option value="Shroud">Shroud</option>
                        <option value="Sorcerer">Sorcerer</option>
                        <option value="Warlock">Warlock</option>
                        <option value="Magus">Magus</option>
                    </select>
                    <input type="number" name="attr_base_level" value="1" style="margin-left: -6px; width: 28px;">
                    <span class="label">CLASS & LEVEL</span>
                </div>
                <div class="hlabel-container">
                    <input class="flag" type="hidden" name="attr_mutliclass1_showingflag" value="0">
                    <input class="hiding" type="text" disabled="true" style="width: 64px; margin-bottom: 30px;">
                    <input class="hiding" type="text" disabled="true" style="margin-left: -6px; width: 28px; margin-bottom: 30px;">
                    <input class="showing" type="text" name="attr_multiclass1_name" value="@{multiclass1}" disabled="true" style="width: 64px; margin-bottom: 30px;">
                    <input class="showing" type="text" name="attr_multiclass1_level" value="@{multiclass1_lvl}" disabled="true" style="margin-left: -6px; width: 28px; margin-bottom: 30px;">
                </div>
                <div class="hlabel-container">
                    <input class="flag" type="hidden" name="attr_mutliclass2_showingflag" value="0">
                    <input class="hiding" type="text" disabled="true" style="width: 64px; margin-bottom: 30px;">
                    <input class="hiding" type="text" disabled="true" style="margin-left: -6px; width: 28px; margin-bottom: 30px;">
                    <input class="showing" type="text" name="attr_multiclass2_name" value="@{multiclass2}" disabled="true" style="width: 64px; margin-bottom: 30px;">
                    <input class="showing" type="text" name="attr_multiclass2_level" value="@{multiclass2_lvl}" disabled="true" style="margin-left: -6px; width: 28px; margin-bottom: 30px;">
                </div>
                <div class="hlabel-container">
                    <input class="flag" type="hidden" name="attr_mutliclass3_showingflag" value="0">
                    <input class="hiding" type="text" disabled="true" style="width: 64px; margin-bottom: 30px;">
                    <input class="hiding" type="text" disabled="true" style="margin-left: -6px; width: 28px; margin-bottom: 30px;">
                    <input class="showing" type="text" name="attr_multiclass3_name" value="@{multiclass3}" disabled="true" style="width: 64px; margin-bottom: 30px;">
                    <input class="showing" type="text" name="attr_multiclass3_level" value="@{multiclass3_lvl}" disabled="true" style="margin-left: -6px; width: 28px; margin-bottom: 30px;">
                </div>
                <div class="hlabel-container">
                    <input type="text" name="attr_background" style="width: 122px;">
                    <span class="label">NEXT LEVEL</span>
                </div>
            </div>
            <div class="bottom">
                <div class="hlabel-container">
                    <input type="text" name="attr_race">
                    <span class="label">RACE</span>
                </div>
                <div class="hlabel-container">
                    <input type="text" name="attr_alignment">
                    <span class="label">SIZE</span>
                </div>
                <div class="hlabel-container">
                    <input type="text" name="attr_experience">
                    <span class="label">EXPERIENCE POINTS</span>
                </div>
            </div>
        </div>
    </div>
    <div class="body">
        <div class="col col1">
            <div class="class_options">
                <div class="row">
                    <span>GLOBAL SAVING THROW MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalsavemod" value="0">
                </div>
                <div class="row">
                    <span>GLOBAL  PHYSICAL ARMOR CLASS MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalpacmod" value="0">
                </div>
                <div class="row">
                    <span>GLOBAL  MENTAL ARMOR CLASS MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalmacmod" value="0">
                </div>
                <div class="row">
                    <span>GLOBAL  PHYSICAL ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalphysattackmod" value="0">
                </div>
                <div class="row">
                    <span>GLOBAL  MAGICAL ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalmagicattackmod" value="0">
                </div>
                <div class="row">
                    <span>GLOBAL  PSYCHIC ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalpsyattackmod" value="0">
                </div>
                <div class="row">
                    <span >GLOBAL  SOCIAL ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_globalsocialattackmod" value="0">
                </div>
                <div class="row title">
                    <span>ATTACK OPTIONS</span>
                </div>
            </div>
			<div class="class_options">
                <div class="row">
                    <span>RACIAL PHYSICAL ARMOR CLASS MODIFIER:</span>
                    <input type="text" class="num" name="attr_racialpacmod" value="0">
                </div>
                <div class="row">
                    <span>RACIAL MENTAL ARMOR CLASS MODIFIER:</span>
                    <input type="text" class="num" name="attr_racialmacmod" value="0">
                </div>
                <div class="row">
                    <span>RACIAL PHYSICAL ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_racialphysattackmod" value="0">
                </div>
                <div class="row">
                    <span>RACIAL MAGICAL ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_racialmagicattackmod" value="0">
                </div>
                <div class="row">
                    <span>RACIAL PSYCHIC ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_racialpsyattackmod" value="0">
                </div>
                <div class="row">
                    <span>RACIAL SOCIAL ATTACK MODIFIER:</span>
                    <input type="text" class="num" name="attr_racialsocialattackmod" value="0">
                </div>
                <div class="row">
                    <span>MOVEMET SPEED:</span>
                    <input type="text" class="num" name="attr_movement" value="0">
                </div>
                <div class="row title">
                    <span>RACIAL BONUSES (<span name="attr_race"></span>)</span>
                </div>
            </div>
			<div class="class_options">
                <div class="row">
                    <span>PREVIOUS PHYSICAL HIT DIE:</span>
                    <input type="text" class="num" name="attr_previous_physical_hd" value="0">
                </div>
                <div class="row">
                    <span>PREVIOUS MENTAL HIT DIE:</span>
                    <input type="text" class="num" name="attr_previous_mental_hd" value="0">
                </div>
                <div class="row">
                    <span>PREVIOUS LEVEL:</span>
                    <input type="text" class="num" name="attr_previous_level" value="0">
                </div>
                <div class="row title">
                    <span>DUAL CLASSING</span>
                </div>
            </div>
        </div>
        <div class="col col2">
            <div class="skill_options" style="width: 234px;">
                <div class="row skill">
                    <span>Alchemy</span>
                    <span name="attr_alchemy_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_alchemy_flat" value="0" title="@{alchemy_flat}">
                </div>
                <div class="row skill">
                    <span>Arcana</span>
                    <span name ="attr_arcana_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_arcana_flat" value="0" title="@{arcana_flat}">
                </div>
                <div class="row skill">
                    <span>Athletics</span>
                    <span name="attr_athletics_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_athletics_flat" value="0" title="@{athletics_flat}">
                </div>
                <div class="row skill">
                    <span>Bureaucracy</span>
                    <span name="attr_bureaucracy_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_bureaucracy_flat" value="0" title="@{bureaucracy_flat}">
                </div>
                <div class="row skill">
                    <span>Craft (</span><input type="text" name="attr_craft_type" value="item" style="width:60px; font-size:9px; text-align:center;"><span>)</span>
                    <span name="attr_craft_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_craft_flat" value="0" title="@{craft_flat}">
                </div>
                <div class="row skill">
                    <span>Devices</span>
                    <span name="attr_devices_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_devices_flat" value="0" title="@{devices_flat}">
                </div>
                <div class="row skill">
                    <span>Healing</span>
					<span name="attr_healing_prof"></span>
                    <span>+</span><input type="text" class="num" name="attr_healing_flat" value="0" title="@{healing_flat}">
                </div>
                <div class="row skill">
                    <span>Infernal Lore</span>
					<span name="attr_infernal_lore_prof"></span>
                    <span>+</span><input type="text" class="num" name="attr_infernal_lore_flat" value="0" title="@{infernal_lore_flat}">
                </div>
                <div class="row skill">
                    <span>Perform (</span><input type="text" name="attr_perform_type" value="instrument"  style="width:60px; font-size:9px; text-align:center;"><span>)</span>
                    <span name="attr_perform_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_perform_flat" value="0" title="@{perform_flat}">
                </div>
                <div class="row skill">
                    <span>Poison Use</span>
                    <span name="attr_poison_use_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_poison_use_flat" value="0" title="@{poison_use_flat}">
                </div>
                <div class="row skill">
                    <span>Prestidigitation</span>
                    <span name="attr_prestidigitation_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_prestidigitation_flat" value="0" title="@{prestidigitation_flat}">
                </div>
				<div class="row skill">
                    <span>Profession (</span><input type="text" name="attr_profession_type" value="job" style="width:60px; font-size:9px; text-align:center;"><span>)</span>
                    <span name="attr_profession_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_profession_flat" value="0" title="@{profession__flat}">
                </div>
                <div class="row skill">
                    <span>Stealth</span>
					<span name="attr_stealth_prof"></span>
                    <span>+</span><input type="text" class="num" name="attr_stealth_flat" value="0" title="@{stealth_flat}">
                </div>
                <div class="row skill">
                    <span>Survival (</span><input type="text" name="attr_survival_type" value="terrain" style="width:60px; font-size:9px; text-align:center;"><span>)</span>
                    <span name="attr_survival_prof"></span>
					<span>+</span><input type="text" class="num" name="attr_survival_flat" value="0" title="@{survival_flat}">
                </div>
                <div class="row title">
                    <span>SKILL OPTIONS</span>
                </div>
            </div>
        </div>
        <div class="col col3">
            <div class="general_options">
                <div class="version">
                    <span >v</span>
                    <input type="text" name="attr_version" value="1.5">
                </div>
                <div class="row">
                    <span>ROLL QUERIES:</span>
                    <select name="attr_rtype">
                        <option value="{{query=1}} ?{Advantage?|Normal Roll,&#123&#123normal=1&#125&#125 &#123&#123r2=[[0d20|Advantage,&#123&#123advantage=1&#125&#125 &#123&#123r2=[[1d20|Disadvantage,&#123&#123disadvantage=1&#125&#125 &#123&#123r2=[[1d20}">Query Advantage</option>
                        <option value="{{always=1}} {{r2=[[1d20">Always Roll Advantage</option>
                        <option value="@{advantagetoggle}">Advantage Toggle</option>
                        <option value="{{normal=1}} {{r2=[[0d20">Never Roll Advantage</option>
                    </select>
                </div>
                <div class="row">
                    <span>WHISPER ROLLS TO GM:</span>
                    <select name="attr_wtype">
                        <option value="">Never Whisper Rolls</option>
                        <option value="?{Whisper?|Public Roll,|Whisper Roll,/w gm }">Query Whisper</option>
                        <option value="/w gm ">Always Whisper Rolls</option>
                    </select>
                </div>
                <div class="row">
                    <span>AUTO DAMAGE ROLL:</span>
                    <select class="dtype" name="attr_dtype">
                        <option value="pick">Don't Auto Roll Damage</option>
                        <option value="full">Auto Roll Damage & Crit</option>
                    </select>
                </div>
                <div class="row">
                    <span>ADD CHARACTER NAME TO TEMPLATES:</span>
                    <select class="dtype" name="attr_charname_output">
                        <option value="{{charname=@{character_name}}}" selected="selected">On</option>
                        <option value="charname=@{character_name}">Off</option>
                    </select>
                </div>
                <div class="row">
                    <span data-i18n="inventory:-u">INVENTORY:</span>
                    <select name="attr_simpleinventory">
                        <option value="complex" data-i18n="compendium-compatible">Compendium Compatible</option>
                        <option value="simple" data-i18n="simple">Simple</option>
                    </select>
                </div>
                <div class="row">
                    <span>ENCUMBERANCE:</span>
                    <select name="attr_encumberance_setting">
                        <option value="on" >On</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                <div class="row">
                    <span>AMMO TRACKING:</span>
                    <select name="attr_ammotracking">
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                    <span data-i18n-title="api-required-title" data-i18n="api-required-u" title="Try it now with easy one click API installation available with your Pro subscription." style="color:#666; cursor:help;">(API REQUIRED)</span>
                </div>
                <div class="row title">
                    <span>GENERAL OPTIONS</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer" style="font-size: 10px; color: rgb(165, 165, 165);">
    <span data-i18n="portions-sheet-utilize">
        Portions of this sheet utilize content from the System Reference Document 5.0 under the OGL License. View OGL License and Copyright Notice. https://wiki.roll20.net/SRD_5.0_OGL_License
    </span>
</div>

</div> <!-- licensecontainer div close -->

<!-- HIDDEN FIELDS -->
<input type="hidden" name="attr_level" value="1">
<input type="hidden" name="attr_acrobatics_proficiency" value="(((@{acrobatics_prof} + @{jack_of_all_trades}) + abs(@{acrobatics_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_animal_handling_proficiency" value="(((@{animal_handling_prof} + @{jack_of_all_trades}) + abs(@{animal_handling_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_arcana_proficiency" value="(((@{arcana_prof} + @{jack_of_all_trades}) + abs(@{arcana_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_athletics_proficiency" value="(((@{athletics_prof} + @{jack_of_all_trades}) + abs(@{athletics_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_deception_proficiency" value="(((@{deception_prof} + @{jack_of_all_trades}) + abs(@{deception_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_history_proficiency" value="(((@{history_prof} + @{jack_of_all_trades}) + abs(@{history_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_insight_proficiency" value="(((@{insight_prof} + @{jack_of_all_trades}) + abs(@{insight_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_intimidation_proficiency" value="(((@{intimidation_prof} + @{jack_of_all_trades}) + abs(@{intimidation_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_investigation_proficiency" value="(((@{investigation_prof} + @{jack_of_all_trades}) + abs(@{investigation_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_medicine_proficiency" value="(((@{medicine_prof} + @{jack_of_all_trades}) + abs(@{medicine_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_nature_proficiency" value="(((@{nature_prof} + @{jack_of_all_trades}) + abs(@{nature_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_perception_proficiency" value="(((@{perception_prof} + @{jack_of_all_trades}) + abs(@{perception_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_performance_proficiency" value="(((@{performance_prof} + @{jack_of_all_trades}) + abs(@{performance_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_persuasion_proficiency" value="(((@{persuasion_prof} + @{jack_of_all_trades}) + abs(@{persuasion_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_religion_proficiency" value="(((@{religion_prof} + @{jack_of_all_trades}) + abs(@{religion_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_sleight_of_hand_proficiency" value="(((@{sleight_of_hand_prof} + @{jack_of_all_trades}) + abs(@{sleight_of_hand_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_stealth_proficiency" value="(((@{stealth_prof} + @{jack_of_all_trades}) + abs(@{stealth_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_survival_proficiency" value="(((@{survival_prof} + @{jack_of_all_trades}) + abs(@{survival_prof} - @{jack_of_all_trades})) / 2)" disabled="true">
<input type="hidden" name="attr_hitdie_final" value="">
<input type="hidden" name="attr_weighttotal" value="">
<input type="hidden" name="attr_globalsavingthrowbonus" value="">
<input type="hidden" name="attr_halflingluck" value="">

</div>

<!-- ROLL TEMPLATES -->
<div class="rolltemplates">
    
    <rolltemplate class="sheet-rolltemplate-simple">
        <div class="container">
            <div class="result">
                    <div class="solo">
                        <span>{{r1}}</span>
                    </div>
            </div>
            <div class="label">
                <span>{{rname}}{{#mod}} <span>({{mod}})</span>{{/mod}}</span>
            </div>
            {{#charname}}
                <div class="charname">
                    <span>{{charname}}</span>
                </div>
            {{/charname}}
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-atk">
        <div class="container">
            <div class="result">
                {{#always}}
                    <div class="adv">
                        <span>{{r1}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}</span>
                    </div>
                {{/always}}
                {{#normal}}
                    <div class="solo">
                        <span>{{r1}}</span>
                    </div>
                {{/normal}}
                {{#advantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/advantage}}
                {{#disadvantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/disadvantage}}
            </div>
            {{#range}}
                <div class="sublabel">
                    <span>{{range}}</span>
                </div>
            {{/range}}
            <div class="label">
                {{#normal}}
                    {{#rollWasCrit() r1}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}
                    {{#^rollWasCrit() r1}}<span>{{rname}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}
                {{/normal}}
                {{#always}}
                    {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                    {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
                {{/always}}
                {{#advantage}}
                    {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                    {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
                {{/advantage}}
                {{#disadvantage}}
                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}<span>{{rname}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollLess() r1 r2}}<span>{{rname}} <span>({{mod}})</span></span>{{/rollLess() r1 r2}}
                    {{#rollGreater() r1 r2}}<span>{{rname}} <span>({{mod}})</span></span>{{/rollGreater() r1 r2}}
                {{/disadvantage}}
            </div>
            {{#charname}}
                <div class="charname">
                    <span>{{charname}}</span>
                </div>
            {{/charname}}
        </div>
        {{#desc}}
            <div class="desc">
                <span>{{desc}}</span>
            </div>
        {{/desc}}
    </rolltemplate>
    
    <rolltemplate class="sheet-rolltemplate-dmg">
        {{#save}}
            {{#attack}}
                <div class="desc save">
            {{/attack}}
            {{^attack}}
                <div class="atk save">
            {{/attack}}
                <div class="savedc">
                    <span>DC{{savedc}}</span>
                </div>
                {{#savedesc}}
                    <div class="sublabel">
                        <span>{{savedesc}}</span>
                    </div>
                {{/savedesc}}
                <div class="label">
                    <span>{{saveattr}} Save</span>
                </div>
            </div>
        {{/save}}
        {{^attack}}
            {{#desc}}
                <div class="desc">
                    <span>{{desc}}</span>
                </div>
            {{/desc}}
        {{/attack}}
        {{#hldmg}}
            {{#^rollTotal() hldmg 0}}
                <div class="desc">
                    <span>{{hldmg}}</span>
                    <span class="sublabel">{{dmg1type}}</span>
                    <div class="label">
                        <span>Higher Level Cast</span>
                    </div>
                </div>
            {{/^rollTotal() hldmg 0}}
        {{/hldmg}}
        <div class="container damagetemplate">
            <div class="result">
                {{#dmg1flag}}
                    {{^dmg2flag}}
                        <div class="solo">
                            <span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
                            <span class="sublabel">{{dmg1type}}</span>
                        </div>
                    {{/dmg2flag}}
                {{/dmg1flag}}
                {{#dmg2flag}}
                    {{^dmg1flag}}
                        <div class="solo">
                            <span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
                            <span class="sublabel">{{dmg2type}}</span>
                        </div>
                    {{/dmg1flag}}
                {{/dmg2flag}}
                {{#dmg1flag}}
                    {{#dmg2flag}}
                        <div class="adv">
                            <span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
                            <span class="sublabel">{{dmg1type}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
                            <span class="sublabel">{{dmg2type}}</span>
                        </div>
                    {{/dmg2flag}}
                {{/dmg1flag}}
            </div>
            {{^attack}}
                {{#range}}
                    <div class="sublabel" style="color: black;">
                        <span>{{range}}</span>
                    </div>
                {{/range}}
                <div class="label">
                    <span>{{rname}}</span>
                </div>
                {{#charname}}
                    <div class="charname">
                        <span>{{charname}}</span>
                    </div>
                {{/charname}}
            {{/attack}}
        </div>
    </rolltemplate>
    
    <rolltemplate class="sheet-rolltemplate-atkdmg">
        {{#attack}}
            <div class="container atk">
                <div class="result">
                    {{#always}}
                        <div class="adv">
                            <span>{{r1}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}</span>
                        </div>
                    {{/always}}
                    {{#normal}}
                        <div class="solo">
                            <span>{{r1}}</span>
                        </div>
                    {{/normal}}
                    {{#advantage}}
                        {{#rollLess() r1 r2}}
                            <div class="adv">
                                <span class="grey">{{r1}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}</span>
                            </div>
                        {{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}</span>
                            </div>
                        {{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span class="grey">{{r2}}</span>
                            </div>
                        {{/rollGreater() r1 r2}}
                    {{/advantage}}
                    {{#disadvantage}}
                        {{#rollLess() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span class="grey">{{r2}}</span>
                            </div>
                        {{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}</span>
                            </div>
                        {{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}
                            <div class="adv">
                                <span class="grey">{{r1}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}</span>
                            </div>
                        {{/rollGreater() r1 r2}}
                    {{/disadvantage}}
                </div>
                {{#range}}
                    <div class="sublabel">
                        <span>{{range}}</span>
                    </div>
                {{/range}}
                <div class="label">
                    <span>{{rname}}{{#attack}} <span>({{mod}})</span>{{/attack}}</span>
                </div>
                {{#charname}}
                    <div class="charname">
                        <span>{{charname}}</span>
                    </div>
                {{/charname}}
            </div>
        {{/attack}}
        {{#save}}
            {{#attack}}
                <div class="container desc save">
            {{/attack}}
            {{^attack}}
                <div class="container atk save">
            {{/attack}}
                <div class="savedc">
                    <span>DC{{savedc}}</span>
                </div>
                {{#savedesc}}
                    <div class="sublabel">
                        <span>{{savedesc}}</span>
                    </div>
                {{/savedesc}}
                <div class="label">
                    <span>{{saveattr}} Save</span>
                </div>
            </div>
        {{/save}}
        {{#desc}}
            <div class="desc">
                <span>{{desc}}</span>
            </div>
        {{/desc}}
        {{#hldmg}}
            {{#^rollTotal() hldmg 0}}
                <div class="desc">
                    <span>{{hldmg}}</span>
                    <span class="sublabel">{{dmg1type}}</span>
                    <div class="label">
                        <span>Higher Level Cast</span>
                    </div>
                </div>
            {{/^rollTotal() hldmg 0}}
        {{/hldmg}}
        {{#damage}}
            <div class="container damagetemplate">
                <div class="result">
                    {{#dmg1flag}}
                        {{^dmg2flag}}
                            <div class="solo">
                                <span class="damage">
                                    {{dmg1}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg1type}}</span>
                            </div>
                        {{/dmg2flag}}
                    {{/dmg1flag}}
                    {{#dmg2flag}}
                        {{^dmg1flag}}
                            <div class="solo">
                                <span class="damage">
                                    {{dmg2}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg2type}}</span>
                            </div>
                        {{/dmg1flag}}
                    {{/dmg2flag}}
                    {{#dmg1flag}}
                        {{#dmg2flag}}
                            <div class="adv">
                                <span class="damage">
                                    {{dmg1}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg1type}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>
                                    {{dmg2}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg2type}}</span>
                            </div>
                        {{/dmg2flag}}
                    {{/dmg1flag}}
                </div>
                {{^attack}}
                    {{#range}}
                        <div class="sublabel">
                            <span>{{range}}</span>
                        </div>
                    {{/range}}
                    <div class="label">
                        <span>{{rname}}</span>
                    </div>
                    {{#charname}}
                        <div class="charname">
                            <span>{{charname}}</span>
                        </div>
                    {{/charname}}
                {{/attack}}
            </div>
        {{/damage}}
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-desc">
        <div class="desc">
            <span>{{desc}}</span>
        </div>
    </rolltemplate>
    
    <rolltemplate class="sheet-rolltemplate-spell">
        <div class="container">
            <div class="title row">
                <span>{{name}}</span>
            </div>
            <div class="italics row">
                <span>{{level}}{{#ritual}} (ritual){{/ritual}}</span>
            </div>
            <div class="spacer"></div>
            {{#castingtime}}
            <div class="row">
                <span class="bold">Casting Time: </span><span>{{castingtime}}<span>
            </div>
            {{/castingtime}}
            {{#range}}
            <div class="row">
                <span class="bold">Range: </span><span>{{range}}<span>
            </div>
            {{/range}}
            {{#target}}
            <div class="row">
                <span class="bold">Target: </span><span>{{target}}<span>
            </div>
            {{/target}}
            <div class="row">
                <span class="bold">Components: </span>
                <span>
                    {{#v}}V{{#s}}, {{/s}}{{^s}}{{#m}}, {{/m}}{{/s}}{{/v}}
                    {{#s}}S{{#m}}, {{/m}}{{/s}}
                    {{#m}}M {{#material}}({{material}}){{/material}}{{/m}}
                <span>
            </div>
            {{#duration}}
            <div class="row">
                <span class="bold">Duration: </span><span>{{#concentration}}Concentration {{/concentration}}{{duration}}<span>
            </div>
            {{/duration}}
            <div class="spacer"></div>
            {{#description}}
            <div class="row">
                <span class="description">{{description}}<span>
            </div>
            {{/description}}
            {{#athigherlevels}}
            <div class="row">
                <span class="bold italics">At Higher Levels. </span><span class="description">{{athigherlevels}}<span>
            </div>
            {{/athigherlevels}}
        </div>
    </rolltemplate>
    

<!-- WORKERS -->
<script type="text/worker">

    on("sheet:opened", function() {
        versioning();

        getAttrs(['meleedmg1','rangeddmg1','pro_weapons','pro_armor','inventoryname1','barbarian_level','bard_level','cleric_level','druid_level','figher_level','monk_level','paladin_level','ranger_level','rogue_level','sorcerer_level','warlock_level','wizard_level','npc_type','npc_size','npc_alignment','npc_hp','npc_HP_hit_dice','npc_AC_note','npc_physique','npc_cunning','npc_constitution','npc_intelligence','npc_ego','npc_charisma','speed','speed_fly','speed_burrow','speed_swim','speed_climb','prolanguages','blindsight','darkvision','tremorsense','truesight','challenge','xp','multiattack','npc_traits','lair_actions','legendary_action_notes','damage_vulnerability','damage_resistance','damage_immunity','condition_immunity'], function(attrs) {
            var hasOldData = false;
            var updates = {};
            _.each(attrs, function(value, key) {
                if(value) {
                    hasOldData = true;
                }
            });
            if(!hasOldData) {
                updates.already_transitioned = '1';
            }
            setAttrs(updates);
        });
    });

    on("change:class change:cust_classname change:cust_hitdietype change:cust_spellcasting_ability change:cust_spellslots change:cust_physique_save_prof change:cust_cunning_save_prof change:cust_constitution_save_prof change:cust_intelligence_save_prof change:cust_ego_save_prof change:cust_charisma_save_prof", function() {
        updateClass();
    });
	on("change:race", function() {
        updaterace();
    });
    
    on("change:custom_class", function() {
        getAttrs(["custom_class"], function(v) {
            if(v.custom_class && v.custom_class === "1") {
                setAttrs({
                    customclass_flag: 1
                });
            }
            else {
                setAttrs({
                    customclass_flag: 0
                });
            };
        });
        updateClass();
    });
        
    on("change:base_level change:multiclass1 change:multiclass1_lvl change:multiclass2 change:multiclass2_lvl change:multiclass3 change:multiclass3_lvl change:arcane_fighter change:arcane_rogue", function() {
		setlevel();
    });
	
    on("change:level change:previous_level", function (){
		updatehb();
    })
    
    on("change:multiclass1_flag", function() {
        setlevel();
        getAttrs(["multiclass1_flag"], function(v) {
            if(v.multiclass1_flag && v.multiclass1_flag === "1") {
                setAttrs({
                    mutliclass1_showingflag: 1
                });
            }
            else {
                setAttrs({
                    mutliclass1_showingflag: 0
                });
            };
        });
    });
    
    on("change:multiclass2_flag", function() {
        setlevel();
        getAttrs(["multiclass2_flag"], function(v) {
            if(v.multiclass2_flag && v.multiclass2_flag === "1") {
                setAttrs({
                    mutliclass2_showingflag: 1
                });
            }
            else {
                setAttrs({
                    mutliclass2_showingflag: 0
                });
            };
        });
    });
    
    on("change:multiclass3_flag", function() {
        setlevel();
        getAttrs(["multiclass3_flag"], function(v) {
            if(v.multiclass3_flag && v.multiclass3_flag === "1") {
                setAttrs({
                    mutliclass3_showingflag: 1
                });
            }
            else {
                setAttrs({
                    mutliclass3_showingflag: 0
                });
            };
        });
    });
	
	on("change:physique", function() {
		updatephysmod();
		});
	on("change:cunning", function() {
		updatecunmod();
		});
	on("change:ego", function() {
		updateegomod();
		});
	on("change:charisma", function() {
		updatechamod();
		});
	
    on("change:repeating_attack:atkflag change:repeating_attack:atkname_base change:repeating_attack:atkattr_base change:repeating_attack:atkmod change:repeating_attack:atkmagic change:repeating_attack:atkprofflag change:repeating_attack:dmgflag change:repeating_attack:dmgbase change:repeating_attack:dmgattr change:repeating_attack:dmgmod change:repeating_attack:dmgtype change:repeating_attack:dmg2flag change:repeating_attack:dmg2base change:repeating_attack:dmg2attr change:repeating_attack:dmg2mod change:repeating_attack:dmg2type change:repeating_attack:saveflag change:repeating_attack:savedc change:repeating_attack:saveflat change:repeating_attack:updateflag change:repeating_attack:dmgcustcrit change:repeating_attack:dmg2custcrit change:repeating_attack:ammo", function(eventinfo) {
        updateAttack(eventinfo);
    });
    
    on("change:dtype", function() {
        force_refresh_attacks();
        force_refresh_npcactions();
        // getAttrs(["dtype"], function(v) {
        //     setAttrs({
        //         dflag: v.dtype
        //     });
        //     var updatepickbase = v.dtype;
        //     getSectionIDs("repeating_attack", function(idarray) {
        //         _.each(idarray, function(currentID) {
        //             getAttrs(["repeating_attack_" + currentID + "_atkflag", "repeating_attack_" + currentID + "_dmgflag"], function(v) {
        //                 update = {};
        //                 if(updatepickbase === "full") {
        //                     update["repeating_attack_" + currentID + "_hidden_pickbase"] = "full";
        //                 }
        //                 else {
        //                     if(!v["repeating_attack_" + currentID + "_atkflag"] || v["repeating_attack_" + currentID + "_atkflag"] != 0) {
        //                         update["repeating_attack_" + currentID + "_hidden_pickbase"] = "pick";
        //                     }
        //                     else if(!v["repeating_attack_" + currentID + "_dmgflag"] || v["repeating_attack_" + currentID + "_dmgflag"] != 0) {
        //                         update["repeating_attack_" + currentID + "_hidden_pickbase"] = "dmg";
        //                     }
        //                     else {
        //                         update["repeating_attack_" + currentID + "_hidden_pickbase"] = "empty";
        //                     }
        //                 }
        //                 setAttrs(update);
        //             });
        //         });
        //     });
        // });
    });
    
    on("change:repeating_spell-cantrip:spellname_base change:repeating_spell-1:spellname_base change:repeating_spell-1:spellprepared change:repeating_spell-2:spellname_base change:repeating_spell-2:spellprepared change:repeating_spell-3:spellname_base change:repeating_spell-3:spellprepared change:repeating_spell-4:spellname_base change:repeating_spell-4:spellprepared change:repeating_spell-5:spellname_base change:repeating_spell-5:spellprepared change:repeating_spell-6:spellname_base change:repeating_spell-6:spellprepared change:repeating_spell-7:spellname_base change:repeating_spell-7:spellprepared change:repeating_spell-8:spellname_base change:repeating_spell-8:spellprepared change:repeating_spell-9:spellname_base change:repeating_spell-9:spellprepared change:repeating_spell-cantrip:spellrange change:repeating_spell-1:spellrange change:repeating_spell-2:spellrange change:repeating_spell-3:spellrange change:repeating_spell-4:spellrange change:repeating_spell-5:spellrange change:repeating_spell-6:spellrange change:repeating_spell-7:spellrange change:repeating_spell-8:spellrange change:repeating_spell-9:spellrange change:repeating_spell-cantrip:spelltarget change:repeating_spell-1:spelltarget change:repeating_spell-2:spelltarget change:repeating_spell-3:spelltarget change:repeating_spell-4:spelltarget change:repeating_spell-5:spelltarget change:repeating_spell-6:spelltarget change:repeating_spell-7:spelltarget change:repeating_spell-8:spelltarget change:repeating_spell-9:spelltarget change:repeating_spell-cantrip:spelldamage change:repeating_spell-1:spelldamage change:repeating_spell-2:spelldamage change:repeating_spell-3:spelldamage change:repeating_spell-4:spelldamage change:repeating_spell-5:spelldamage change:repeating_spell-6:spelldamage change:repeating_spell-7:spelldamage change:repeating_spell-8:spelldamage change:repeating_spell-9:spelldamage change:repeating_spell-cantrip:spelldamagetype change:repeating_spell-1:spelldamagetype change:repeating_spell-2:spelldamagetype change:repeating_spell-3:spelldamagetype change:repeating_spell-4:spelldamagetype change:repeating_spell-5:spelldamagetype change:repeating_spell-6:spelldamagetype change:repeating_spell-7:spelldamagetype change:repeating_spell-8:spelldamagetype change:repeating_spell-9:spelldamagetype change:repeating_spell-cantrip:spelldamage2 change:repeating_spell-1:spelldamage2 change:repeating_spell-2:spelldamage2 change:repeating_spell-3:spelldamage2 change:repeating_spell-4:spelldamage2 change:repeating_spell-5:spelldamage2 change:repeating_spell-6:spelldamage2 change:repeating_spell-7:spelldamage2 change:repeating_spell-8:spelldamage2 change:repeating_spell-9:spelldamage2 change:repeating_spell-cantrip:spelldamagetype2 change:repeating_spell-1:spelldamagetype2 change:repeating_spell-2:spelldamagetype2 change:repeating_spell-3:spelldamagetype2 change:repeating_spell-4:spelldamagetype2 change:repeating_spell-5:spelldamagetype2 change:repeating_spell-6:spelldamagetype2 change:repeating_spell-7:spelldamagetype2 change:repeating_spell-8:spelldamagetype2 change:repeating_spell-9:spelldamagetype2 change:repeating_spell-cantrip:spellhealing change:repeating_spell-1:spellhealing change:repeating_spell-2:spellhealing change:repeating_spell-3:spellhealing change:repeating_spell-4:spellhealing change:repeating_spell-5:spellhealing change:repeating_spell-6:spellhealing change:repeating_spell-7:spellhealing change:repeating_spell-8:spellhealing change:repeating_spell-9:spellhealing change:repeating_spell-cantrip:spelldmgmod change:repeating_spell-1:spelldmgmod change:repeating_spell-2:spelldmgmod change:repeating_spell-3:spelldmgmod change:repeating_spell-4:spelldmgmod change:repeating_spell-5:spelldmgmod change:repeating_spell-6:spelldmgmod change:repeating_spell-7:spelldmgmod change:repeating_spell-8:spelldmgmod change:repeating_spell-9:spelldmgmod change:repeating_spell-cantrip:spellsave change:repeating_spell-1:spellsave change:repeating_spell-2:spellsave change:repeating_spell-3:spellsave change:repeating_spell-4:spellsave change:repeating_spell-5:spellsave change:repeating_spell-6:spellsave change:repeating_spell-7:spellsave change:repeating_spell-8:spellsave change:repeating_spell-9:spellsave change:repeating_spell-cantrip:spellsavesuccess change:repeating_spell-1:spellsavesuccess change:repeating_spell-2:spellsavesuccess change:repeating_spell-3:spellsavesuccess change:repeating_spell-4:spellsavesuccess change:repeating_spell-5:spellsavesuccess change:repeating_spell-6:spellsavesuccess change:repeating_spell-7:spellsavesuccess change:repeating_spell-8:spellsavesuccess change:repeating_spell-9:spellsavesuccess change:repeating_spell-cantrip:spellhldie change:repeating_spell-1:spellhldie change:repeating_spell-2:spellhldie change:repeating_spell-3:spellhldie change:repeating_spell-4:spellhldie change:repeating_spell-5:spellhldie change:repeating_spell-6:spellhldie change:repeating_spell-7:spellhldie change:repeating_spell-8:spellhldie change:repeating_spell-9:spellhldie change:repeating_spell-cantrip:spellhldietype change:repeating_spell-1:spellhldietype change:repeating_spell-2:spellhldietype change:repeating_spell-3:spellhldietype change:repeating_spell-4:spellhldietype change:repeating_spell-5:spellhldietype change:repeating_spell-6:spellhldietype change:repeating_spell-7:spellhldietype change:repeating_spell-8:spellhldietype change:repeating_spell-9:spellhldietype change:repeating_spell-cantrip:spell_updateflag change:repeating_spell-1:spell_updateflag change:repeating_spell-2:spell_updateflag change:repeating_spell-3:spell_updateflag change:repeating_spell-4:spell_updateflag change:repeating_spell-5:spell_updateflag change:repeating_spell-6:spell_updateflag change:repeating_spell-7:spell_updateflag change:repeating_spell-8:spell_updateflag change:repeating_spell-9:spell_updateflag change:repeating_spell-cantrip:spellattack change:repeating_spell-1:spellattack change:repeating_spell-2:spellattack change:repeating_spell-3:spellattack change:repeating_spell-4:spellattack change:repeating_spell-5:spellattack change:repeating_spell-6:spellattack change:repeating_spell-7:spellattack change:repeating_spell-8:spellattack change:repeating_spell-9:spellattack change:repeating_spell-cantrip:spellhlbonus change:repeating_spell-1:spellhlbonus change:repeating_spell-2:spellhlbonus change:repeating_spell-3:spellhlbonus change:repeating_spell-4:spellhlbonus change:repeating_spell-5:spellhlbonus change:repeating_spell-6:spellhlbonus change:repeating_spell-7:spellhlbonus change:repeating_spell-8:spellhlbonus change:repeating_spell-9:spellhlbonus change:repeating_spell-npc:spellname_base change:repeating_spell-npc:spellrange change:repeating_spell-npc:spelltarget change:repeating_spell-npc:spelldamage change:repeating_spell-npc:spelldamagetype change:repeating_spell-npc:spelldamage2 change:repeating_spell-npc:spelldamagetype2 change:repeating_spell-npc:spellhealing change:repeating_spell-npc:spelldmgmod change:repeating_spell-npc:spellsave change:repeating_spell-npc:spellsavesuccess change:repeating_spell-npc:spellhldie change:repeating_spell-npc:spellhldietype change:repeating_spell-npc:spell_updateflag change:repeating_spell-npc:spellattack change:repeating_spell-npc:spellhlbonus change:repeating_spell-npc:spellprepared", function(eventinfo) {
        updateSpell("","",eventinfo);
    });

    on("change:repeating_spell-cantrip:spellritualflag change:repeating_spell-1:spellritualflag change:repeating_spell-2:spellritualflag change:repeating_spell-3:spellritualflag change:repeating_spell-4:spellritualflag change:repeating_spell-5:spellritualflag change:repeating_spell-6:spellritualflag change:repeating_spell-7:spellritualflag change:repeating_spell-8:spellritualflag change:repeating_spell-9:spellritualflag change:repeating_spell-npc:spellritualflag", function() {
        getAttrs(["repeating_spell_spellritualflag"], function(v) {
            flag = v.repeating_spell_spellritualflag === "Yes" ? "{{ritual=1}}" : "0";
            setAttrs({
                repeating_spell_spellritual: flag
            });
        });
    });

    on("change:repeating_spell-cantrip:spellconcentrationflag change:repeating_spell-1:spellconcentrationflag change:repeating_spell-2:spellconcentrationflag change:repeating_spell-3:spellconcentrationflag change:repeating_spell-4:spellconcentrationflag change:repeating_spell-5:spellconcentrationflag change:repeating_spell-6:spellconcentrationflag change:repeating_spell-7:spellconcentrationflag change:repeating_spell-8:spellconcentrationflag change:repeating_spell-9:spellconcentrationflag change:repeating_spell-npc:spellconcentrationflag", function() {
        getAttrs(["repeating_spell_spellconcentrationflag"], function(v) {
            flag = v.repeating_spell_spellconcentrationflag === "Yes" ? "{{concentration=1}}" : "0";
            setAttrs({
                repeating_spell_spellconcentration: flag
            });
        });
    });
    
    on("change:repeating_spell-cantrip:spellcomp change:repeating_spell-1:spellcomp change:repeating_spell-2:spellcomp change:repeating_spell-3:spellcomp change:repeating_spell-4:spellcomp change:repeating_spell-5:spellcomp change:repeating_spell-6:spellcomp change:repeating_spell-7:spellcomp change:repeating_spell-8:spellcomp change:repeating_spell-9:spellcomp change:repeating_spell-npc:spellcomp", function() {
        getAttrs(["repeating_spell_spellcomp"], function(v) {
            spellv = v.repeating_spell_spellcomp.indexOf("V") > -1 ? "{{v=1}}" : "0"
            spells = v.repeating_spell_spellcomp.indexOf("S") > -1 ? "{{s=1}}" : "0"
            spellm = v.repeating_spell_spellcomp.indexOf("M") > -1 ? "{{m=1}}" : "0"
            setAttrs({
                repeating_spell_spellcomp_v: spellv,
                repeating_spell_spellcomp_s: spells,
                repeating_spell_spellcomp_m: spellm
            });
        });
    });

    on("change:repeating_spell-cantrip:spellcontent change:repeating_spell-1:spellcontent change:repeating_spell-2:spellcontent change:repeating_spell-3:spellcontent change:repeating_spell-4:spellcontent change:repeating_spell-5:spellcontent change:repeating_spell-6:spellcontent change:repeating_spell-7:spellcontent change:repeating_spell-8:spellcontent change:repeating_spell-9:spellcontent change:repeating_spell-npc:spellcontent", function() {
        getAttrs(["repeating_spell_spellcontent"], function(v) {
            content = v.repeating_spell_spellcontent.split("At Higher Levels:");
            if(content.length > 1) {
                spelldesc = content[0].trim();
                spellhigherlvl = content[1].trim();
            }
            else {
                spelldesc = v.repeating_spell_spellcontent;
                spellhigherlvl = "";
            }
            setAttrs({
                repeating_spell_spelldescription: spelldesc,
                repeating_spell_spellathigherlevels: spellhigherlvl
            });
        });
    });

    // on("change:repeating_spell-cantrip:spellhealing change:repeating_spell-1:spellhealing change:repeating_spell-2:spellhealing change:repeating_spell-3:spellhealing change:repeating_spell-4:spellhealing change:repeating_spell-5:spellhealing change:repeating_spell-6:spellhealing change:repeating_spell-7:spellhealing change:repeating_spell-8:spellhealing change:repeating_spell-9:spellhealing", function() {
    //     getAttrs(["repeating_spell_spellhealing","repeating_spell_spelldamage","repeating_spell_spelldamage2","repeating_spell_spelldmgmod"], function(v) {
    //         if(v.repeating_spell_spellhealing && v.repeating_spell_spellhealing != "") {
    //             update = {};
    //             // castingbonus = v.repeating_spell_spelldmgmod && v.repeating_spell_spelldmgmod === "Yes" ? " + @{spellcasting_ability}" : "";
    //             if(!v.repeating_spell_spelldamage || v.repeating_spell_spelldamage === "") {
    //                 update["repeating_spell_spelldamage"] = v.repeating_spell_spellhealing;
    //             }
    //             else if(!v.repeating_spell_spelldamage2 || v.repeating_spell_spelldamage2 === "") {
    //                 update["repeating_spell_spelldamage2"] = v.repeating_spell_spellhealing;
    //             }
    //             update["repeating_spell_spellhealing"] = "";
    //             setAttrs(update);
    //         }
    //     });
    // });

    on("change:repeating_spell-cantrip:spelloutput change:repeating_spell-1:spelloutput change:repeating_spell-2:spelloutput change:repeating_spell-3:spelloutput change:repeating_spell-4:spelloutput change:repeating_spell-5:spelloutput change:repeating_spell-6:spelloutput change:repeating_spell-7:spelloutput change:repeating_spell-8:spelloutput change:repeating_spell-9:spelloutput change:repeating_spell-npc:spelloutput", function(eventinfo) {
        var idlvl = "-" + eventinfo.sourceAttribute.match(/repeating_spell-(.*?)-/)[1];
        var spid = eventinfo.sourceAttribute.split("_")[2];
        var ourid = idlvl + spid;
        getAttrs(["repeating_spell_spellattackid","repeating_spell_spelloutput","character_id","repeating_spell_pickbase"], function(v) {
            if(v.repeating_spell_spelloutput === "ATTACK") {
                // if(idlvl != "-npc_") {
                setAttrs({repeating_spell_spellattackinfoflag:"show"});
                if(!v.repeating_spell_spellattackid) {
                    addspellattack(ourid);
                } 
                else {
                    getSectionIDs("repeating_attack", function(idarray) {
                        var existingid = _.find(idarray, function(thisid) { 
                            return (thisid.toLowerCase() === v.repeating_spell_spellattackid.toLowerCase() ) 
                        });
                        if(!existingid) {
                            addspellattack(ourid);
                        }
                        else {
                            getAttrs(["repeating_attack_" + v.repeating_spell_spellattackid + "_hidden_pickbase"], function(x) {
                                // pbase = x["repeating_attack_" + v.repeating_spell_spellattackid + "_hidden_pickbase"];
                                setAttrs({
                                    repeating_spell_rollcontent: "%{" + v.character_id + "|repeating_attack_" + v.repeating_spell_spellattackid + "_attack}"
                                });
                            });
                        }
                    });
                };
                // }
                // else {
                //     setAttrs({
                //         repeating_spell_rollcontent: "@{rollbase}"
                //     });
                //     updateNPCspell(eventinfo);
                // }
            }
            else {
                setAttrs({
                    repeating_spell_rollcontent: "@{wtype}&{template:spell} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname_base}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} @{spellconcentration} @{charname_output}",
                    repeating_spell_spellattackinfoflag: "hide"
                });
            }
        });
    });

    on("change:repeating_spell-cantrip:spelldamage change:repeating_spell-1:spelldamage change:repeating_spell-2:spelldamage change:repeating_spell-3:spelldamage change:repeating_spell-4:spelldamage change:repeating_spell-5:spelldamage change:repeating_spell-6:spelldamage change:repeating_spell-7:spelldamage change:repeating_spell-8:spelldamage change:repeating_spell-9:spelldamage change:repeating_spell-npc:spelldamage change:repeating_spell-cantrip:spellhealing change:repeating_spell-1:spellhealing change:repeating_spell-2:spellhealing change:repeating_spell-3:spellhealing change:repeating_spell-4:spellhealing change:repeating_spell-5:spellhealing change:repeating_spell-6:spellhealing change:repeating_spell-7:spellhealing change:repeating_spell-8:spellhealing change:repeating_spell-9:spellhealing change:repeating_spell-npc:spellhealing", function() {
        getAttrs(["repeating_spell_spelldamage","repeating_spell_spellhealing"], function(v) {
            if((v.repeating_spell_spelldamage && v.repeating_spell_spelldamage != "") || (v.repeating_spell_spellhealing && v.repeating_spell_spellhealing != "")) {
                setAttrs({
                    repeating_spell_spelloutput: "ATTACK"
                });
            }
        });
    });

    // on("change:repeating_spell-cantrip:spelldmgmod change:repeating_spell-1:spelldmgmod change:repeating_spell-2:spelldmgmod change:repeating_spell-3:spelldmgmod change:repeating_spell-4:spelldmgmod change:repeating_spell-5:spelldmgmod change:repeating_spell-6:spelldmgmod change:repeating_spell-7:spelldmgmod change:repeating_spell-8:spelldmgmod change:repeating_spell-9:spelldmgmod", function() {
    //     getAttrs(["repeating_spell_spelldmgmod","repeating_spell_spelldamage","repeating_spell_spelldamage2","repeating_spell_spellhealing"], function(v) {
    //         if(v.repeating_spell_spelldmgmod && v.repeating_spell_spelldmgmod != "" && (!v.repeating_spell_spellhealing) || v.repeating_spell_spellhealing ==="") {
    //             update = {};
    //             castingbonus = v.repeating_spell_spelldmgmod && v.repeating_spell_spelldmgmod === "Yes" ? " + @{spellcasting_ability}" : ""
    //             if(v.repeating_spell_spelldamage && v.repeating_spell_spelldamage != "") {
    //                 update["repeating_spell_spelldamage"] = v.repeating_spell_spelldamage + castingbonus;
    //             }
    //             else if(v.repeating_spell_spelldamage2 && v.repeating_spell_spelldamage2 != "") {
    //                 update["repeating_spell_spelldamage2"] = v.repeating_spell_spelldamage2 + castingbonus;
    //             }
    //             setAttrs(update);
    //         }
    //     });
    // });

    // on("change:repeating_attack:hidden_pickbase", function(eventinfo) {
    //     getAttrs(["repeating_attack_hidden_pickbase"], function(x) {
    //         getSectionIDs("repeating_spell", function(idarray) {
    //             attackid = eventinfo.sourceAttribute.substring(17, 37);
    //             _.each(idarray, function(currentID) {
    //                 getAttrs(["repeating_spell-cantrip_" + currentID + "_spelloutput","repeating_spell-cantrip_" + currentID + "_spellattackid","repeating_spell-1_" + currentID + "_spelloutput","repeating_spell-1_" + currentID + "_spellattackid","repeating_spell-2_" + currentID + "_spelloutput","repeating_spell-2_" + currentID + "_spellattackid","repeating_spell-3_" + currentID + "_spelloutput","repeating_spell-3_" + currentID + "_spellattackid","repeating_spell-4_" + currentID + "_spelloutput","repeating_spell-4_" + currentID + "_spellattackid","repeating_spell-5_" + currentID + "_spelloutput","repeating_spell-5_" + currentID + "_spellattackid","repeating_spell-6_" + currentID + "_spelloutput","repeating_spell-6_" + currentID + "_spellattackid","repeating_spell-7_" + currentID + "_spelloutput","repeating_spell-7_" + currentID + "_spellattackid","repeating_spell-8_" + currentID + "_spelloutput","repeating_spell-8_" + currentID + "_spellattackid","repeating_spell-9_" + currentID + "_spelloutput","repeating_spell-9_" + currentID + "_spellattackid","character_name"], function(v) {
    //                     lvl = Object.keys(v)[0].match(/repeating_spell-(.*?)-/);
    //                     if(lvl && v["repeating_spell-" + lvl[1] + currentID + "_spellattackid"] && v["repeating_spell-" + lvl[1] + currentID + "_spellattackid"].toLowerCase() === attackid && v["repeating_spell-" + lvl[1] + currentID + "_spelloutput"] === "ATTACK") {
    //                         update = {};
    //                         update["repeating_spell-" + lvl[1] + currentID + "_rollcontent"] = "%{" + v.character_name + "|repeating_attack_" + attackid + "_attack_" + x.repeating_attack_hidden_pickbase + "}";
    //                         setAttrs(update);
    //                     }
    //                 });
    //             });
    //         });
    //     })

    // });
	
    on("change:simpleinventory", function() {
        getAttrs(["simpleinventory"], function(v) {
            setAttrs({
               inventoryflag: v.simpleinventory
            });
        });
    });

    on("change:repeating_inventory:itemweight change:repeating_inventory:equipped change:repeating_inventory:itemcount change:cb change:cp change:cs change:sp change:gc change:pc change:physique", function() {
        updateitemweight();
    });

    on("change:repeating_inventory:itemtype", function(eventinfo) {
        id = eventinfo.sourceAttribute.substring(20, 40);
        getAttrs(["repeating_inventory_itemtype","repeating_inventory_itemname"], function(v) {
            if(v.repeating_inventory_itemtype) {
                updateglobalsave();
                if(v.repeating_inventory_itemtype.indexOf("Weapon") > -1) {
                    existingattacks = [];
                    getSectionIDs("repeating_attack", function(idarray) {
                        if(idarray.length > 0) {
                            _.each(idarray, function(currentID, i) {
                                getAttrs(["repeating_attack_" + currentID + "_atkname_base"], function(x) {
                                    if(v["repeating_attack_" + currentID + "_atkname_base"] && v["repeating_attack_" + currentID + "_atkname_base"] != "") {
                                        existingattacks.push(x["repeating_attack_" + currentID + "_atkname_base"].toLowerCase());
                                    }
                                    if(i === idarray.length - 1 && v.repeating_inventory_itemname) {
                                        if(existingattacks.indexOf(v.repeating_inventory_itemname.toLowerCase()) === -1) {
                                            additemattack(id);
                                        }
                                    }
                                });
                            })
                        }
                        else {
                            additemattack(id);
                        }
                    });
                }
                else {
                    updateac();
                }
            }
            else {
                updateac();
                updateitemweight();
                updateglobalsave();
            }
        });
    });

    on("remove:repeating_spell-cantrip remove:repeating_spell-1 remove:repeating_spell-2 remove:repeating_spell-3 remove:repeating_spell-4 remove:repeating_spell-5 remove:repeating_spell-6 remove:repeating_spell-7 remove:repeating_spell-8 remove:repeating_spell-9 remove:repeating_spell-npc", function(eventinfo) {
        id = eventinfo.sourceAttribute.split("_")[2];
        getSectionIDs("repeating_attack", function(idarray) {
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_attack_" + currentID + "_spellid"], function(v) {
                    var spellid = v["repeating_attack_" + currentID + "_spellid"] && v["repeating_attack_" + currentID + "_spellid"].indexOf("_") > -1 ? v["repeating_attack_" + currentID + "_spellid"].split("_")[1] : v["repeating_attack_" + currentID + "_spellid"];
                    if(spellid === id.toLowerCase()) {
                        removeRepeatingRow("repeating_attack_" + currentID);
                    }
                });
            });
        });
    });

    on("remove:repeating_inventory", function(eventinfo) {
        id = eventinfo.sourceAttribute.substring(20, 40);
        getSectionIDs("repeating_attack", function(idarray) {
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_attack_" + currentID + "_itemid"], function(v) {
                    if(v["repeating_attack_" + currentID + "_itemid"] === id.toLowerCase()) {
                        removeRepeatingRow("repeating_attack_" + currentID);
                    }
                });
            });
        });
        getAttrs(["other_resource_itemid"], function(v) {
            if(v["other_resource_itemid"] === id.toLowerCase()) {
                update["other_resource_itemid"] = "";
                update["other_resource"] = "";
                update["other_resource_name"] = "";
                update["other_resource_max"] = "";
                setAttrs(update);
            }
        });
        getSectionIDs("repeating_resource", function(idarray) {
            var update = {};
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_resource_" + currentID + "_resource_left_itemid","repeating_resource_" + currentID + "_resource_right_itemid"], function(v) {
                    if(v["repeating_resource_" + currentID + "_resource_left_itemid"] === id.toLowerCase()) {
                        update["repeating_resource_" + currentID + "_resource_left_itemid"] = "";
                        update["repeating_resource_" + currentID + "_resource_left"] = "";
                        update["repeating_resource_" + currentID + "_resource_left_name"] = "";
                        update["repeating_resource_" + currentID + "_resource_left_max"] = "";
                        setAttrs(update);
                    }
                    if(v["repeating_resource_" + currentID + "_resource_right_itemid"] === id.toLowerCase()) {
                        update["repeating_resource_" + currentID + "_resource_right_itemid"] = "";
                        update["repeating_resource_" + currentID + "_resource_right"] = "";
                        update["repeating_resource_" + currentID + "_resource_right_name"] = "";
                        update["repeating_resource_" + currentID + "_resource_right_max"] = "";
                        setAttrs(update);
                    }
                });
            });
        });
        updateac();
        updateitemweight();
        updateglobalsave();
    });

    on("change:cunning change:repeating_inventory:equipped change:globalacmod change:repeating_inventory:itemmodifiers change:custom_ac_flag change:custom_ac_base change:custom_ac_part1 change:custom_ac_part2", function() {
        getAttrs(["simpleinventory","custom_ac_flag"], function(v) {
            if(v.custom_ac_flag === "1") {
                getAttrs(["custom_ac_base","custom_ac_part1","custom_ac_part2","physique","cunning","constitution","intelligence","ego","charisma"], function(b) {
                    var base = isNaN(parseInt(b.custom_ac_base, 10)) === false ? parseInt(b.custom_ac_base, 10) : 10;
                    var part1attr = b.custom_ac_part1.toLowerCase();
                    var part2attr = b.custom_ac_part2.toLowerCase();
                    var part1 = part1attr === "none" ? 0 : Math.floor((parseInt(b[part1attr])-10)/2);
                    var part2 = part2attr === "none" ? 0 : Math.floor((parseInt(b[part2attr])-10)/2);
                    var total = base + part1 + part2;
                    setAttrs({ac: total});
                });
            }
            else if(v.simpleinventory === "complex") {
                updateac();
            }
        });
    });

    on("change:repeating_inventory:itemmodifiers", function() {
        updateglobalsave();
        getAttrs(["repeating_inventory_itemmodifiers"], function(v) {
            if(v.repeating_inventory_itemmodifiers && v.repeating_inventory_itemmodifiers.toLowerCase().indexOf("spell attack") > -1) {
                var spellbonus = 0;
                getSectionIDs("repeating_inventory", function(idarray) {
                    if(idarray.length > 0) {
                        _.each(idarray, function(currentID, i) {
                            getAttrs(["repeating_inventory_" + currentID + "_itemmodifiers"], function(x) {
                                if(x["repeating_inventory_" + currentID + "_itemmodifiers"] && x["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().indexOf("spell attack") > -1) {
                                    spellbonus = spellbonus + parseInt(x["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().split("spell attack +")[1].substring(0,1), 10);
                                }
                                if(i === idarray.length - 1) {
                                    setAttrs({globalmagicmod: spellbonus});
                                }
                            });
                        });
                    }
                });
            }
        });
    });

    on("change:armorwarning", function() {
        getAttrs(["armorwarning"], function(v) {
            if(v.armorwarning === "hide") {
                setAttrs({armorwarningflag: "0"});
            }
        });
    });

    on("change:spellcasting_ability change:physique change:cunning change:constitution change:intelligence change:ego change:charisma", function() {
        getSectionIDs("repeating_attack", function(idarray) {
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_attack_" + currentID + "_updateflag"], function(v) {
                    update = {};
                    toggle = v["repeating_attack_" + currentID + "_updateflag"] === true ? false : true;
                    update["repeating_attack_" + currentID + "_updateflag"] = toggle;
                    setAttrs(update);
                });
            });
        });
    });

    on("change:globalsavemod", function() {
        getAttrs(["globalsavemod"], function(v) {
            bonus = v.globalsavemod && v.globalsavemod != "" ? "+@{globalsavemod}[UNIV]" : "";
            setAttrs({globalsavingthrowbonus: bonus});
        });
    });

    on("change:weighttotal change:encumberance_setting change:physique", function() {
        getAttrs(["weighttotal","encumberance_setting","physique"], function(v) {
            var update = {};
            var phys = parseInt(v.physique, 10);
            var weight = parseInt(v.weighttotal, 10);
            if(!v.encumberance_setting || v.encumberance_setting === "on") {
                if(weight > phys) {
                    update["encumberance"] = "OVER CARRYING CAPACITY";
                }
                else if(weight == phys) {
                    update["encumberance"] = "HEAVILY ENCUMBERED";
                }
                else if(weight >= phys*0.75) {
                    update["encumberance"] = "MODERATELY ENCUMBERED";
                }
				                
				else if(weight >= phys*0.5) {
                    update["encumberance"] = "LIGHTLY ENCUMBERED";
                }
                else {
                    update["encumberance"] = " ";
                }
            }
            setAttrs(update);
        });
    });
    on("change:repeating_inventory:useasresource change:repeating_inventory:itemcount change:repeating_inventory:itemname", function(eventinfo) {
        itemid = eventinfo.sourceAttribute.substring(20, 40);
        sourcetype = eventinfo.sourceType;
        var update = {};
        var newrowid = generateRowID();
        getAttrs(["repeating_inventory_itemresourceid","repeating_inventory_useasresource","repeating_inventory_itemcount","repeating_inventory_itemname","repeating_inventory_itemattackid"], function(v) {
            var count = v["repeating_inventory_itemcount"] && v["repeating_inventory_itemcount"] != "" ? v["repeating_inventory_itemcount"] : 0;
            var name = v["repeating_inventory_itemname"] && v["repeating_inventory_itemname"] != "" ? v["repeating_inventory_itemname"] : "";
            if(v.repeating_inventory_useasresource && v.repeating_inventory_useasresource === "1") {
                if(v.repeating_inventory_itemresourceid && v.repeating_inventory_itemresourceid != "") {
                    if(sourcetype && sourcetype === "player") {
                        if(v.repeating_inventory_itemresourceid === "other_resource") {
                            update["other_resource"] = count;
                            update["other_resource_name"] = name;
                        }
                        else {
                            update["repeating_resource_" + v.repeating_inventory_itemresourceid] = count;
                            update["repeating_resource_" + v.repeating_inventory_itemresourceid + "_name"] = name;
                        }
                        setAttrs(update, {silent: true});
                    }
                }
                else {
                    getAttrs(["other_resource_name"], function(x) {
                        if(x.other_resource_name && x.other_resource_name != "") {
                            getSectionIDs("repeating_resource", function(idarray) {
                                if(idarray.length > 0) {
                                    var match = false;
                                    _.each(idarray, function(currentID, i) {
                                        getAttrs(["repeating_resource_" + currentID + "_resource_left_name","repeating_resource_" + currentID + "_resource_right_name"], function(y) {
                                            if((!y["repeating_resource_" + currentID + "_resource_left_name"] || y["repeating_resource_" + currentID + "_resource_left_name"] === "") && match === false) {
                                                match = true;
                                                update["repeating_inventory_itemresourceid"] = currentID + "_resource_left";
                                                update["repeating_resource_" + currentID + "_resource_left_itemid"] = itemid;
                                                update["repeating_resource_" + currentID + "_resource_left"] = count;
                                                update["repeating_resource_" + currentID + "_resource_left_name"] = name;
                                            }
                                            else if((!y["repeating_resource_" + currentID + "_resource_right_name"] || y["repeating_resource_" + currentID + "_resource_right_name"] === "") && match === false){
                                                match = true;
                                                update["repeating_inventory_itemresourceid"] = currentID + "_resource_right";
                                                update["repeating_resource_" + currentID + "_resource_right_itemid"] = itemid;
                                                update["repeating_resource_" + currentID + "_resource_right"] = count;
                                                update["repeating_resource_" + currentID + "_resource_right_name"] = name;
                                            }
                                            if(i === idarray.length - 1 && match === false) {
                                                update["repeating_inventory_itemresourceid"] = newrowid + "_resource_left";
                                                update["repeating_resource_" + newrowid + "_resource_left_itemid"] = itemid;
                                                update["repeating_resource_" + newrowid + "_resource_left"] = count;
                                                update["repeating_resource_" + newrowid + "_resource_left_name"] = name;
                                            }
                                            setAttrs(update, {silent: true});
                                        });
                                    });
                                }
                                else {
                                    update["repeating_inventory_itemresourceid"] = newrowid + "_resource_left";
                                    update["repeating_resource_" + newrowid + "_resource_left_itemid"] = itemid;
                                    update["repeating_resource_" + newrowid + "_resource_left"] = count;
                                    update["repeating_resource_" + newrowid + "_resource_left_name"] = name;
                                    setAttrs(update, {silent: true});
                                }
                            });
                        }
                        else {
                            update["repeating_inventory_itemresourceid"] = "other_resource";
                            update["other_resource_itemid"] = itemid;
                            update["other_resource"] = count;
                            update["other_resource_name"] = name;
                            setAttrs(update, {silent: true});
                        }
                    });
                }
            }
            else {
                if(v.repeating_inventory_itemresourceid && v.repeating_inventory_itemresourceid != "") {
                    update["repeating_inventory_itemresourceid"] = "";
                    if(v.repeating_inventory_itemresourceid === "other_resource") {
                        update["other_resource"] = "";
                        update["other_resource_name"] = "";
                        update["other_resource_max"] = "";
                    }
                    else {
                        update["repeating_resource_" + v.repeating_inventory_itemresourceid] = "";
                        update["repeating_resource_" + v.repeating_inventory_itemresourceid + "_name"] = "";
                        update["repeating_resource_" + v.repeating_inventory_itemresourceid + "_max"] = "";
                    }
                    setAttrs(update, {silent: true});
                }
            }
            if(sourcetype && sourcetype === "player" && v["repeating_inventory_itemattackid"] && v["repeating_inventory_itemattackid"] != "") {
                update["repeating_attack_" + v["repeating_inventory_itemattackid"] + "_atkname_base"] = name;
                setAttrs(update);
            }
        });
    });
    on("change:other_resource change:other_resource_name change:repeating_resource:resource_left change:repeating_resource:resource_left_name change:repeating_resource:resource_right change:repeating_resource:resource_right_name", function(eventinfo) {
        if(eventinfo.sourceType && eventinfo.sourceType === "player") {
            var update = {};
            if(eventinfo.sourceAttribute === "other_resource") {
                getAttrs(["other_resource_itemid","other_resource","other_resource_name"], function(v) {
                    update["repeating_inventory_" + v["other_resource_itemid"] + "_itemcount"] = v["other_resource"];
                    update["repeating_inventory_" + v["other_resource_itemid"] + "_itemname"] = v["other_resource_name"];
                    setAttrs(update, {silent: true});
                });
            }
            else if(eventinfo.sourceAttribute.indexOf("left") > -1) {
                getAttrs(["repeating_resource_resource_left_itemid","repeating_resource_resource_left","repeating_resource_resource_left_name"], function(v) {
                    update["repeating_inventory_" + v["repeating_resource_resource_left_itemid"] + "_itemcount"] = v["repeating_resource_resource_left"];
                    update["repeating_inventory_" + v["repeating_resource_resource_left_itemid"] + "_itemname"] = v["repeating_resource_resource_left_name"];
                    setAttrs(update, {silent: true});
                });
            }
            else if(eventinfo.sourceAttribute.indexOf("right") > -1) {
                getAttrs(["repeating_resource_resource_right_itemid","repeating_resource_resource_right","repeating_resource_resource_right_name"], function(v) {
                    update["repeating_inventory_" + v["repeating_resource_resource_right_itemid"] + "_itemcount"] = v["repeating_resource_resource_right"];
                    update["repeating_inventory_" + v["repeating_resource_resource_right_itemid"] + "_itemname"] = v["repeating_resource_resource_right_name"];
                    setAttrs(update, {silent: true});
                });
            }
        }
    });
    on("change:repeating_attack:savedc", function() {
        getAttrs(["repeating_attack_savedc"], function(v) {
            var update = {};
            if(v.repeating_attack_savedc && v.repeating_attack_savedc === "(@{saveflat})") {
                update["repeating_attack_flatflag"] = "show";
            }
            else {
                update["repeating_attack_flatflag"] = "hide";
            }
            setAttrs(update);
        });
    });
    on("change:charname_output change:globalmagicmod", function() {
        force_refresh_attacks();
    });
    on("change:rtype", function() {
        var update = {};
        getAttrs(["rtype"], function(v) {
            if(v.rtype && v.rtype === "@{advantagetoggle}") {
                update["toggleflag"] = "show";
            }
            else {
                update["toggleflag"] = "hide";
            }
            setAttrs(update);
        });
    });
    on("change:npc_spelldc change:npc_spellattackmod change:spellcasting_ability ", function() {
        force_refresh_spells();
    });
    on("change:ammotracking", function() {
        getAttrs(["ammotracking"], function(v) {
            if(v["ammotracking"] && v["ammotracking"] === "on") {
                setAttrs({ammoflag: "show"});
            }
            else {
                setAttrs({ammoflag: "hide"});
            }
        });
    });
	
	on("change:hb change:physique_mod change:globalphysattackmod change:racialphysattackmod", function() {
	updatephysattackmod();
	});
	on("change:hb change:physique_mod change:globalmagicattackmod change:racialmagicattackmod", function() {
	updatemagicattackmod();
	});
	on("change:hb change:physique_mod change:globalpsyattackmod change:racialpsyattackmod", function() {
	updatepsyattackmod();
	});
	on("change:hb change:physique_mod change:globalsocialattackmod change:racialsocialattackmod", function() {
	updatesocialattackmod();
	});
	
	var updatephysmod = function() {
		getAttrs(["physique"], function(v) {
			var physmod = 0;
			var physique = parseInt(v.physique, 10);
			if(physique <= 5) {
				physmod = -2;
			}
			else if(physique <= 8) {
				physmod = -1;
			}
			else if(physique <= 12) {
				physmod = 0;
			}
			else if(physique <= 15) {
				physmod = 1;
			}
			else if(physique >= 16) {
				physmod = 2;
			}
			setAttrs({physique_mod: physmod});
		});
	}
	var updatecunmod = function() {
		getAttrs(["cunning"], function(v) {
			var cunmod = 0;
			var cunning = parseInt(v.cunning, 10);
			if(cunning <= 5) {
				cunmod = -2;
			}
			else if(cunning <= 8) {
				cunmod = -1;
			}
			else if(cunning <= 12) {
				cunmod = 0;
			}
			else if(cunning <= 15) {
				cunmod = 1;
			}
			else if(cunning >= 16) {
				cunmod = 2;
			}
			setAttrs({cunning_mod: cunmod});
		});
	}
	var updateegomod = function() {
		getAttrs(["ego"], function(v) {
			var egomod = 0;
			var ego = parseInt(v.ego, 10);
			if(ego <= 5) {
				egomod = -2;
			}
			else if(ego <= 8) {
				egomod = -1;
			}
			else if(ego <= 12) {
				egomod = 0;
			}
			else if(ego <= 15) {
				egomod =1;
			}
			else if(ego >= 16) {
				egomod = 2;
			}
			setAttrs({ego_mod: egomod});
		});
	}
	var updatechamod = function() {
		getAttrs(["charisma"], function(v) {
			var chamod = 0;
			var cha = parseInt(v.charisma, 10);
			if(cha <= 5) {
				chamod = -2;
			}
			else if(cha <= 8) {
				chamod = -1;
			}
			else if(cha <= 12) {
				chamod = 0;
			}
			else if(cha <= 15) {
				chamod = 1;
			}
			else if(cha >= 16) {
				chamod = 2;
			}
			setAttrs({charisma_mod: chamod});
		});
	}
	
		var updatehb = function () {
		getAttrs(["level", "previous_level"], function(v) {
		var blvl = parseInt(v.level, 10);
		var plvl = parseInt(v.previous_level, 10);
		var lvl = blvl + plvl
		var guess0 = 0;
		var guess1 = 0;
		var guess2 = 0;
		var guess3 = 0;
		var guess4 = 0;
		var guess5 = 0;
		var hb = 0;
		guess0 = 1;
		guess1 = ((guess0 + lvl / guess0) / 2);
		guess2 = ((guess1 + lvl / guess1) / 2);
		guess3 = ((guess2 + lvl / guess2) / 2);
		guess4 = ((guess3 + lvl / guess3) / 2);
		guess5 = ((guess4 + lvl / guess4) / 2);
		hb = (Math.floor(guess5));
		setAttrs({hb: hb});
	});
	}
	var updatephysattackmod = function () {
		getAttrs (["hb", "physique_mod", "globalphysattackmod", "racialphysattackmod"], function(v) {
			var hb = parseInt(v.hb, 10);
			var physmod = parseInt(v.physique_mod, 10);
			var mod = parseInt(v.globalphysattackmod, 10);
			var race = parseInt(v.racialphysattackmod, 10);
			var phys_attack = 0;
			phys_attack = hb + physmod + mod + race;
			setAttrs({physical_attack_mod: phys_attack});
			});
	}
	var updatemagicattackmod = function () {
		getAttrs (["hb", "cunning_mod", "globalmagicattackmod", "racialmagicattackmod"], function(v) {
			var hb = parseInt(v.hb, 10);
			var cunmod = parseInt(v.cunning_mod, 10);
			var mod = parseInt(v.globalmagicattackmod, 10);
			var race = parseInt(v.racialmagicattackmod, 10);
			var magic_attack = 0;
			magic_attack = hb + cunmod + mod + race;
			setAttrs({magical_attack_mod: magic_attack});
			});
	}
	var updatepsyattackmod = function () {
		getAttrs (["hb", "ego_mod", "globalpsyattackmod", "racialpsyattackmod"], function(v) {
			var hb = parseInt(v.hb, 10);
			var egomod = parseInt(v.ego_mod, 10);
			var mod = parseInt(v.globalpsyattackmod, 10);
			var race = parseInt(v.racialpsyattackmod, 10);
			var psy_attack = 0;
			psy_attack = hb + egomod + mod + race;
			setAttrs({psychic_attack_mod: psy_attack});
			});
	}
	var updatesocialattackmod = function () {
		getAttrs (["hb", "charisma_mod", "globalsocialattackmod", "racialsocialattackmod"], function(v) {
			var hb = parseInt(v.hb, 10);
			var chamod = parseInt(v.charisma_mod, 10);
			var mod = parseInt(v.globalsocialattackmod, 10);
			var race = parseInt(v.racialsocialattackmod, 10);
			var social_attack = 0;
			social_attack = hb + chamod + mod + race;
			setAttrs({social_attack_mod: social_attack});
			});
	}
	
    var updateitemweight = function() {
        var wtotal = 0;
		var itemslots = 0;
        getAttrs(["cb", "cp","cs","sp","gc","pc","physique"], function(v) {
            cb = isNaN(parseInt(v.cb, 10)) === false ? parseInt(v.cb, 10) : 0;		
            cp = isNaN(parseInt(v.cp, 10)) === false ? parseInt(v.cp, 10) : 0;
			cs = isNaN(parseInt(v.cs, 10)) === false ? parseInt(v.cs, 10) : 0;
            sp = isNaN(parseInt(v.sp, 10)) === false ? parseInt(v.sp, 10) : 0;
            gc = isNaN(parseInt(v.gc, 10)) === false ? parseInt(v.gc, 10) : 0;
            pc = isNaN(parseInt(v.pc, 10)) === false ? parseInt(v.pc, 10) : 0;
			var phys = parseInt(v.physique, 10);
            wtotal = wtotal + Math.floor(((cp + sp + gc) / 200) + ((cb) / 1600) + ((cs + pc) / 2000));
            getSectionIDs("repeating_inventory", function(idarray) {
                if(idarray.length > 0) {
                    _.each(idarray, function(currentID, i) {
                        getAttrs(["repeating_inventory_" + currentID + "_itemweight", "repeating_inventory_" + currentID + "_itemcount"], function(v) {
                            if(v["repeating_inventory_" + currentID + "_itemweight"] && isNaN(parseInt(v["repeating_inventory_" + currentID + "_itemweight"], 10)) === false) {
                                count = v["repeating_inventory_" + currentID + "_itemcount"] && isNaN(parseFloat(v["repeating_inventory_" + currentID + "_itemcount"])) === false ? parseFloat(v["repeating_inventory_" + currentID + "_itemcount"]) : 1;
                                wtotal = wtotal + (parseFloat(v["repeating_inventory_" + currentID + "_itemweight"]) * count);
                            }
                            if(i === idarray.length - 1) {
                                itemslots = Math.floor(phys - wtotal);
								setAttrs({weighttotal: wtotal});
								setAttrs({itemslots: itemslots});
                            }
                        });
                    });
                }
                else {
                    setAttrs({weighttotal: wtotal});
					itemslots = Math.floor(phys - wtotal);
					setAttrs({itemslots: itemslots});
                }
                
            });
        });
    }
    var updateac = function() {
        var itemtypes = [];
        getSectionIDs("repeating_inventory", function(idarray) {
            if(idarray.length > 0) {
                _.each(idarray, function(currentID, i) {
                    getAttrs(["repeating_inventory_" + currentID + "_itemtype","repeating_inventory_" + currentID + "_equipped"], function(x) {
                        var update = {};
                        if(x["repeating_inventory_" + currentID + "_equipped"] === "0") {
                            update["repeating_inventory_" + currentID + "_equippedflag"] = "unequipped";
                        }
                        else {
                            update["repeating_inventory_" + currentID + "_equippedflag"] = "equipped";
                        }
                        setAttrs(update);
                        if(x["repeating_inventory_" + currentID + "_itemtype"] && (!x["repeating_inventory_" + currentID + "_equipped"] || x["repeating_inventory_" + currentID + "_equipped"] === "1")) {
                            itemtypes.push(x["repeating_inventory_" + currentID + "_itemtype"].toLowerCase());
                        }
                        if(i === idarray.length - 1) {
                            armorcount = itemtypes.filter(function(item){ return item.indexOf("armor") > -1 }).length
                            shieldcount = itemtypes.filter(function(item){ return item.indexOf("shield") > -1 }).length
                            if(armorcount > 1 || shieldcount > 1) {
                                setAttrs({
                                    armorwarningflag: "show",
                                    armorwarning: "0"
                                });
                            }
                            else {
                                setAttrs({
                                    armorwarningflag: "hide",
                                    armorwarning: "0"
                                });
                                setac(itemtypes);
                            }
                        }
                    });
                })
            }
            else {
                getAttrs(["cunning"], function(v) {
                    setAttrs({ac: 10 + Math.floor((parseInt(v.cunning, 10) - 10) / 2)})
                });
            }
            
        });
    }
    var setac = function (itemtypes) {
        var actotal = 0;
        getSectionIDs("repeating_inventory", function(idarray) {
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_inventory_" + currentID + "_itemac","repeating_inventory_" + currentID + "_equipped","repeating_inventory_" + currentID + "_itemmodifiers","cunning","globalacmod"], function(v) {
                    var dexmod = Math.floor((parseInt(v.cunning, 10) - 10) / 2);
                    var globalacmod = isNaN(parseInt(v.globalacmod, 10)) === false ? parseInt(v.globalacmod, 10) : 0;
                    if(v["repeating_inventory_" + currentID + "_itemac"] && isNaN(parseInt(v["repeating_inventory_" + currentID + "_itemac"], 10)) === false && (!v["repeating_inventory_" + currentID + "_equipped"] || v["repeating_inventory_" + currentID + "_equipped"] === "1")) {
                        actotal = actotal + parseInt(v["repeating_inventory_" + currentID + "_itemac"], 10);
                    }
                    if(v["repeating_inventory_" + currentID + "_itemmodifiers"] && v["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().indexOf("ac +") > -1 && (!v["repeating_inventory_" + currentID + "_equipped"] || v["repeating_inventory_" + currentID + "_equipped"] === "1")) {
                        newac = v["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().split("ac")[1].match(/\d/);
                        actotal = actotal + parseInt(newac[0], 10);
                    }
                    if(i === idarray.length - 1) {
                        if(itemtypes.indexOf("light armor") > -1) {
                            actotal = actotal + dexmod;
                        }
                        else if(itemtypes.indexOf("medium armor") > -1) {
                            actotal = actotal + Math.min(dexmod, 2);
                        }
                        else if(itemtypes.indexOf("heavy armor") > -1) {
                            actotal = actotal;
                        }
                        else {
                            actotal = actotal + 10 + dexmod;
                        }
                        actotal = actotal + globalacmod;
                        setAttrs({ac: actotal});
                    }
                });
            })
        });
    }
    var updateglobalsave = function() {
        var savetotal = 0;
        getSectionIDs("repeating_inventory", function(idarray) {
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_inventory_" + currentID + "_itemmodifiers"], function(v) {
                    if(v["repeating_inventory_" + currentID + "_itemmodifiers"] && v["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().indexOf("saving throws +") > -1) {
                        newmod = v["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().split("saving throws")[1].match(/\d/);
                        savetotal = savetotal + parseInt(newmod[0], 10);
                    }
                    if(i === idarray.length - 1) {
                        setAttrs({globalsavemod: savetotal});
                    }
                });
            })
        });
    }
    var additemattack = function(id) {
        getAttrs(["repeating_inventory_itemname","repeating_inventory_itemproperties","repeating_inventory_itemmodifiers","repeating_inventory_itemdamage","repeating_inventory_itemdamage2","repeating_inventory_itemdamagetype","repeating_inventory_itemrange","repeating_inventory_itemtype"], function(v) {
            var newrowid = generateRowID();
            var newrowattrs = {};
            newrowattrs["repeating_inventory_itemattackid"] = newrowid;
            newrowattrs["repeating_attack_" + newrowid + "_itemid"] = id;
            newrowattrs["repeating_attack_" + newrowid + "_options-flag"] = "0";
            if(v.repeating_inventory_itemname && v.repeating_inventory_itemname != "") {
                newrowattrs["repeating_attack_" + newrowid + "_atkname_base"] = v.repeating_inventory_itemname;
            }
            if(v.repeating_inventory_itemdamage && v.repeating_inventory_itemdamage != "") {
                newrowattrs["repeating_attack_" + newrowid + "_dmgbase"] = v.repeating_inventory_itemdamage;
            }
            if(v.repeating_inventory_itemdamagetype && v.repeating_inventory_itemdamagetype != "") {
                newrowattrs["repeating_attack_" + newrowid + "_dmgtype"] = v.repeating_inventory_itemdamagetype;
            }
            if(v.repeating_inventory_itemrange && v.repeating_inventory_itemrange != "") {
                newrowattrs["repeating_attack_" + newrowid + "_atkrange"] = v.repeating_inventory_itemrange;
            }
            if(v.repeating_inventory_itemtype.indexOf("Melee") > -1) {
                newrowattrs["repeating_attack_" + newrowid + "_atkattr_base"] = "@{physique_mod}";
                newrowattrs["repeating_attack_" + newrowid + "_dmgattr"] = "@{physique_mod}";
            }
            else {
                newrowattrs["repeating_attack_" + newrowid + "_atkattr_base"] = "@{cunning_mod}";
                newrowattrs["repeating_attack_" + newrowid + "_dmgattr"] = "@{cunning_mod}";
            }
            if(v.repeating_inventory_itemmodifiers.indexOf("Attacks") > -1 && v.repeating_inventory_itemmodifiers.indexOf("Damage")) {
                newrowattrs["repeating_attack_" + newrowid + "_atkmagic"] = v.repeating_inventory_itemmodifiers.replace( /(^.+\D)(\d+)(\D.+$)/i,'$2').substring(0,1);
            }
            setAttrs(newrowattrs);
        });
    }
    var addspellattack = function(sid) {
        getAttrs(["repeating_spell_spelloutput","repeating_spell_spellname_base","repeating_spell_spellrange","repeating_spell_spellattack","spellcasting_ability","repeating_spell_spelldamage","repeating_spell_spelldamagetype","repeating_spell_spelldamage2","repeating_spell_spelldamagetype2","repeating_spell_spellsave","repeating_spell_spellsavesuccess","repeating_spell_spellattackid","character_id","repeating_spell_spellhldie","repeating_spell_spellhldietype","repeating_spell_spellhlbonus","repeating_spell_spelldmgmod","repeating_spell_spellhealing","repeating_spell_spelllevel","npc_spellattackmod","level","npc_spelldc"], function(v) {
            var newrowid = generateRowID();
            var newrowattrs = {};
            var npcspell = sid.substring(0,4) === "-npc" ? true : false;
            newrowattrs["repeating_spell_spellattackid"] = newrowid;
            newrowattrs["repeating_spell_rollcontent"] = "%{" + v.character_id + "|repeating_attack_" + newrowid + "_attack}";
            newrowattrs["repeating_attack_" + newrowid + "_options-flag"] = "0";
            newrowattrs["repeating_attack_" + newrowid + "_atkname_base"] = v.repeating_spell_spellname_base;
            newrowattrs["repeating_attack_" + newrowid + "_spellid"] = sid;
            if(v.repeating_spell_spellrange && v.repeating_spell_spellrange != "") {
                newrowattrs["repeating_attack_" + newrowid + "_atkrange"] = v.repeating_spell_spellrange;
            }
            if(!v.repeating_spell_spellattack || v.repeating_spell_spellattack === "None") {
                newrowattrs["repeating_attack_" + newrowid + "_atkflag"] = "0";
            }
            else {
                newrowattrs["repeating_attack_" + newrowid + "_atkattr_base"] = v.spellcasting_ability.slice(0, -1);
            }
            if(v.repeating_spell_spelldamage && v.repeating_spell_spelldamage != "") {
                newrowattrs["repeating_attack_" + newrowid + "_dmgbase"] = v.repeating_spell_spelldamage;
                newrowattrs["repeating_attack_" + newrowid + "_dmgtype"] = v.repeating_spell_spelldamagetype;
                if(v.repeating_spell_spelldmgmod && v.repeating_spell_spelldmgmod === "Yes") {
                    newrowattrs["repeating_attack_" + newrowid + "_dmgattr"] = v.spellcasting_ability.slice(0, -1);
                }
                else {
                    newrowattrs["repeating_attack_" + newrowid + "_dmgattr"] = "0";
                }
            }
            else {
                newrowattrs["repeating_attack_" + newrowid + "_dmgflag"] = "0";
            }
            if(v.repeating_spell_spelldamage2 && v.repeating_spell_spelldamage2 != "") {
                newrowattrs["repeating_attack_" + newrowid + "_dmg2flag"] = "{{damage=1}} {{dmg2flag=1}}";
                newrowattrs["repeating_attack_" + newrowid + "_dmg2base"] = v.repeating_spell_spelldamage2;
                newrowattrs["repeating_attack_" + newrowid + "_dmg2attr"] = "0";
                newrowattrs["repeating_attack_" + newrowid + "_dmg2type"] = v.repeating_spell_spelldamagetype2;
            }
            if(v.repeating_spell_spellsave && v.repeating_spell_spellsave != "") {
                newrowattrs["repeating_attack_" + newrowid + "_saveflag"] = "{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}";
                newrowattrs["repeating_attack_" + newrowid + "_saveattr"] = v.repeating_spell_spellsave;
                newrowattrs["repeating_attack_" + newrowid + "_saveeffect"] = v.repeating_spell_spellsavesuccess;
            }
            if(v.repeating_spell_spellhldie && v.repeating_spell_spellhldie != "" && v.repeating_spell_spellhldietype && v.repeating_spell_spellhldietype != "") {
                var bonus = "";
                var query = "?{Cast at what level?";
                for(i = 0; i < 10-v.repeating_spell_spelllevel; i++) {
                    query = query + "|Level " + (parseInt(i, 10) + parseInt(v.repeating_spell_spelllevel, 10)) + "," + i;
                }
                query = query + "}";
                if(v.repeating_spell_spellhlbonus && v.repeating_spell_spellhlbonus != "") {
                    bonus = "+(" + v.repeating_spell_spellhlbonus + "*" + query + ")";
                }
                newrowattrs["repeating_attack_" + newrowid + "_hldmg"] = "{{hldmg=[[(" + v.repeating_spell_spellhldie + "*" + query + ")" + v.repeating_spell_spellhldietype + bonus + "]]}}";
            }
            if(v.repeating_spell_spellhealing && v.repeating_spell_spellhealing != "") {
                if(!v.repeating_spell_spelldamage || v.repeating_spell_spelldamage === "") {
                    newrowattrs["repeating_attack_" + newrowid + "_dmgflag"] = "{{damage=1}} {{dmg1flag=1}}";
                    newrowattrs["repeating_attack_" + newrowid + "_dmgbase"] = v.repeating_spell_spellhealing;
                    newrowattrs["repeating_attack_" + newrowid + "_dmgtype"] = "Healing";
                    if(v.repeating_spell_spelldmgmod && v.repeating_spell_spelldmgmod === "Yes") {
                        newrowattrs["repeating_attack_" + newrowid + "_dmgattr"] = v.spellcasting_ability.slice(0, -1);
                    }
                    else {
                        newrowattrs["repeating_attack_" + newrowid + "_dmgattr"] = "0";
                    }
                } 
                else if(!v.repeating_spell_spelldamage2 || v.repeating_spell_spelldamage2 === "") {
                    newrowattrs["repeating_attack_" + newrowid + "_dmg2flag"] = "{{damage=1}} {{dmg2flag=1}}";
                    newrowattrs["repeating_attack_" + newrowid + "_dmg2base"] = v.repeating_spell_spellhealing;
                    newrowattrs["repeating_attack_" + newrowid + "_dmg2type"] = "Healing";
                    if(v.repeating_spell_spelldmgmod && v.repeating_spell_spelldmgmod === "Yes") {
                        newrowattrs["repeating_attack_" + newrowid + "_dmg2attr"] = v.spellcasting_ability.slice(0, -1);
                    }
                    else {
                        newrowattrs["repeating_attack_" + newrowid + "_dmg2attr"] = "0";
                    }
                }
            }
            if(npcspell === true) {
                var pb = Math.ceil((v.level)/1e10) + Math.ceil((v.level)/4);
                pb = isNaN(pb) === false ? pb : 0;
                newrowattrs["repeating_attack_" + newrowid + "_atkattr_base"] = "0";
                newrowattrs["repeating_attack_" + newrowid + "_atkmod"] = v.npc_spellattackmod && isNaN(parseInt(v.npc_spellattackmod, 10)) === false ? parseInt(v.npc_spellattackmod, 10) - pb : 0 - pb;
                newrowattrs["repeating_attack_" + newrowid + "_savedc"] = "(@{saveflat})";
                newrowattrs["repeating_attack_" + newrowid + "_saveflat"] = v.npc_spelldc && isNaN(parseInt(v.npc_spelldc, 10)) === false ? parseInt(v.npc_spelldc, 10) : 0;
            }
            setAttrs(newrowattrs);
        });
    }
    var setlevel = function() {
       getAttrs(["base_level","multiclass1_flag","multiclass2_flag","multiclass3_flag","multiclass1_lvl","multiclass2_lvl","multiclass3_lvl","class","multiclass1","multiclass2","multiclass3", "arcane_fighter", "arcane_rogue", "custom_class", "cust_spellslots"], function(v) {
            var multiclass = false;
            var casterlevel = 0;
            var m1casterlevel = 0;
            var m2casterlevel = 0;
            var m3casterlevel = 0;
            var m1hitdie = "";
            var m2hitdie = "";
            var m3hitdie = "";
            var d10class = ["Heavy Knight","Paladin","Outrider"];
            var d8class = ["Inheritor","Inquisitor","Druid","Mystic","Shroud","Warlock"];
            var d6class = ["Sorcerer","Magus"];
            var charclass = v.custom_class && v.custom_class != "0" ? v.cust_spellslots : v.class;
            var full = ["Inheritor","Inquisitor","Druid","Sorcerer","Magus","full"];
            var half = ["Paladin","Outrider","half"];
            var finallevel = (v.base_level && v.base_level > 0) ? parseInt(v.base_level,10) : 1;
            
            if(v.multiclass1_flag && v.multiclass1_flag === "1") {
                finallevel = finallevel + parseInt(v.multiclass1_lvl,10); 
                multiclass = true;
                if(full.indexOf(v.multiclass1) != -1) {
                    m1casterlevel = parseInt(v.multiclass1_lvl,10)
                }
                else if(half.indexOf(v.multiclass1) != -1) {
                    m1casterlevel = Math.floor(parseInt(v.multiclass1_lvl,10)/2)
                }
                else if((v.multiclass1 === "Heavy Knight" && v.arcane_fighter === "1") || (v.multiclass1 === "Shroud" && v.arcane_rogue === "1")) {
                    m1casterlevel = Math.floor(parseInt(v.multiclass1_lvl,10)/3)
                }
                if(v.multiclass1 === "Thug") {m1hd = "12"}
                else if (d10class.indexOf(v.multiclass1) != -1) {m1hd = "10"}
                else if (d8class.indexOf(v.multiclass1) != -1) {m1hd = "8"}
                else if (d6class.indexOf(v.multiclass1) != -1) {m1hd = "6"};
                m1hitdie = "|" + v.multiclass1 + "," + m1hd;
            };
            if(v.multiclass2_flag && v.multiclass2_flag === "1") {
                finallevel = finallevel + parseInt(v.multiclass2_lvl,10); 
                multiclass = true;
                if(full.indexOf(v.multiclass2) != -1) {
                    m2casterlevel = parseInt(v.multiclass2_lvl,10)
                }
                else if(half.indexOf(v.multiclass2) != -1) {
                    m2casterlevel = Math.floor(parseInt(v.multiclass2_lvl,10)/2)
                }
                else if((v.multiclass2 === "Heavy Knight" && v.arcane_fighter === "1") || (v.multiclass2 === "Shroud" && v.arcane_rogue === "1")) {
                    m2casterlevel = Math.floor(parseInt(v.multiclass2_lvl,10)/3)
                }
                if(v.multiclass2 === "Thug") {m2hd = "12"}
                else if (d10class.indexOf(v.multiclass2) != -1) {m2hd = "10"}
                else if (d8class.indexOf(v.multiclass2) != -1) {m2hd = "8"}
                else if (d6class.indexOf(v.multiclass2) != -1) {m2hd = "6"};
                m2hitdie = "|" + v.multiclass2 + "," + m2hd;
            };
            if(v.multiclass3_flag && v.multiclass3_flag === "1") {
                finallevel = finallevel + parseInt(v.multiclass3_lvl,10); 
                multiclass = true;
                if(full.indexOf(v.multiclass3) != -1) {
                    m3casterlevel = parseInt(v.multiclass3_lvl,10)
                }
                else if(half.indexOf(v.multiclass3) != -1) {
                    m3casterlevel = Math.floor(parseInt(v.multiclass3_lvl,10)/2)
                }
                else if((v.multiclass3 === "Heavy Knight" && v.arcane_fighter === "1") || (v.multiclass3 === "Shroud" && v.arcane_rogue === "1")) {
                    m3casterlevel = Math.floor(parseInt(v.multiclass3_lvl,10)/3)
                }
                if(v.multiclass3 === "Thug") {m3hd = "12"}
                else if (d10class.indexOf(v.multiclass3) != -1) {m3hd = "10"}
                else if (d8class.indexOf(v.multiclass3) != -1) {m3hd = "8"}
                else if (d6class.indexOf(v.multiclass3) != -1) {m3hd = "6"};
                m3hitdie = "|" + v.multiclass3 + "," + m3hd;
            };
            
            if(multiclass === false) {
                if(full.indexOf(charclass) != -1) {
                    casterlevel = finallevel
                }
                else if(half.indexOf(charclass) != -1) {
                    casterlevel = finallevel === 1 ? 0 : Math.ceil(finallevel/2)
                }
                else if((charclass === "Heavy Knight" && v.arcane_fighter === "1") || (charclass === "Shroud" && v.arcane_rogue === "1") || (charclass === "third")) {
                    casterlevel = finallevel < 3 ? 0 : Math.ceil(finallevel/3)
                }
                hitdie_final = "@{hitdietype}"
            }
            else {
                if(full.indexOf(charclass) != -1) {
                    casterlevel = parseInt(v.base_level,10)
                }
                else if(half.indexOf(charclass) != -1) {
                    casterlevel = Math.floor(parseInt(v.base_level,10)/2)
                }
                else if((charclass === "Heavy Knight" && v.arcane_fighter === "1") || (charclass === "Shroud" && v.arcane_rogue === "1") || (charclass === "third")) {
                    casterlevel = Math.floor(parseInt(v.base_level,10)/3)
                }
                casterlevel = casterlevel + m1casterlevel + m2casterlevel + m3casterlevel
                hitdie_final = "?{Hit Die Class|" + charclass + ",@{hitdietype}" + m1hitdie + m2hitdie + m3hitdie + "}"
            }
            
            setAttrs({
               level: finallevel,
               caster_level: casterlevel,
               hitdie_final: hitdie_final
            });
            
            updateSpellSlots(casterlevel);
        });
    }
    
    var updateClass = function() {
        getAttrs(["class","base_level","custom_class","cust_classname","cust_hitdietype","cust_spellcasting_ability","cust_physique_save_prof","cust_cunning_save_prof","cust_constitution_save_prof","cust_intelligence_save_prof","cust_ego_save_prof","cust_charisma_save_prof","physique_save_prof","cunning_save_prof","constitution_save_prof","intelligence_save_prof","ego_save_prof","charisma_save_prof"], function(v) {
            if(v.custom_class && v.custom_class != "0") {
                setAttrs({
                    hitdietype: v.cust_hitdietype,
                    spellcasting_ability: v.cust_spellcasting_ability,
                    physique_save_prof: v.cust_physique_save_prof,
                    cunning_save_prof: v.cust_cunning_save_prof,
                    constitution_save_prof: v.cust_constitution_save_prof,
                    intelligence_save_prof: v.cust_intelligence_save_prof,
                    ego_save_prof: v.cust_ego_save_prof,
                    charisma_save_prof: v.cust_charisma_save_prof
                });
            }
            else {
                update = {};
                switch(v.class) {
                    case "Paladin":
                        update["physical_hit_die"] = "d8";
						update["mental_hit_die"] = "d6";
						update["save"] = 17;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Heavy Knight":
                        update["physical_hit_die"] = "d12";
						update["mental_hit_die"] = "d4";
						update["save"] = 20;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Thug":
                        update["physical_hit_die"] = "d8";
						update["mental_hit_die"] = "d6";
						update["save"] = 18;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Inquisitor":
                        update["physical_hit_die"] = "d8";
						update["mental_hit_die"] = "d8";
						update["save"] = 16;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Outrider":
                        update["physical_hit_die"] = "d8";
						update["mental_hit_die"] = "d6";
						update["save"] = 15;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Shroud":
                        update["physical_hit_die"] = "d6";
						update["mental_hit_die"] = "d6";
						update["save"] = 18;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Magus":
                        update["physical_hit_die"] = "d4";
						update["mental_hit_die"] = "d8";
						update["save"] = 20;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Mystic":
                        update["physical_hit_die"] = "d6";
						update["mental_hit_die"] = "d12";
						update["save"] = 20;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Sorcerer":
                        update["physical_hit_die"] = "d4";
						update["mental_hit_die"] = "d8";
						update["save"] = 18;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Warlock":
                        update["physical_hit_die"] = "d6";
						update["mental_hit_die"] = "d8";
						update["save"] = 20;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Druid":
                        update["physical_hit_die"] = "d8";
						update["mental_hit_die"] = "d8";
						update["save"] = 17;
                        update["spellcasting_ability"] = "0*";
                        break;
                    case "Inheritor":
                        update["physical_hit_die"] = "d6";
						update["mental_hit_die"] = "d6";
						update["save"] = 19;
                        update["spellcasting_ability"] = "0*";
                        break;
                }
                setAttrs(update);
            };
        });
    };
	var updaterace = function() {
        getAttrs(["race","racialphysattackmod","racialmagicattackmod","racialpsyattackmod","racialsocialattackmod","movement","size"], function(v) {
                update = {};
                switch(v.race) {
                    case "Black Orc":
                        update["racialphysattackmod"] = 2;
                        update["racialmagicattackmod"] = 2;
                        update["racialpsyattackmod"] = 0;
                        update["racialsocialattackmod"] = 0;
						update["racialpacmod"] = 0;
						update["racialmacmod"] = 0;
						update["movement"] = 12;
						update["size"] = 0;
						update["stealth_flat"] = 0;
                        break;
                    case "Bogill":
                        update["racialphysattackmod"] = 0;
                        update["racialmagicattackmod"] = 2;
                        update["racialpsyattackmod"] = 0;
                        update["racialsocialattackmod"] = 0;
						update["racialpacmod"] = 0;
						update["racialmacmod"] = 0;
						update["movement"] = 15;
						update["size"] = 1;
						update["stealth_flat"] = 1;
                        break;
                    case "Devilkin":
                        update["racialphysattackmod"] = 0;
                        update["racialmagicattackmod"] = 0;
                        update["racialpsyattackmod"] = 2;
                        update["racialsocialattackmod"] = 2;
						update["racialpacmod"] = 0;
						update["racialmacmod"] = 1;
						update["movement"] = 12;
						update["size"] = 0;
						update["stealth_flat"] = 0;
                        break;
                    case "Giant":
                        update["racialphysattackmod"] = 4;
                        update["racialmagicattackmod"] = 0;
                        update["racialpsyattackmod"] = 0;
                        update["racialsocialattackmod"] = 0;
						update["racialpacmod"] = 0;
						update["racialmacmod"] = 0;
						update["movement"] = 15;
						update["size"] = 1;
						update["stealth_flat"] = 0;
                        break;
                    case "Human":
                        update["racialphysattackmod"] = 0;
                        update["racialmagicattackmod"] = 0;
                        update["racialpsyattackmod"] = 0;
                        update["racialsocialattackmod"] = 0;
						update["racialpacmod"] = 0;
						update["racialmacmod"] = 0;
						update["movement"] = 12;
						update["size"] = 0;
						update["stealth_flat"] = 0;
                        break;
					case "Hobgoblin":
                        update["racialphysattackmod"] = 4;
                        update["racialmagicattackmod"] = 0;
                        update["racialpsyattackmod"] = 0;
                        update["racialsocialattackmod"] = 0;
						update["racialpacmod"] = 2;
						update["racialmacmod"] = 0;
						update["movement"] = 12;
						update["size"] = 0;
						update["stealth_flat"] = 0;
                        break;
					case "Red Troll":
                        update["racialphysattackmod"] = 0;
                        update["racialmagicattackmod"] = 2;
                        update["racialpsyattackmod"] = 0;
                        update["racialsocialattackmod"] = 0;
						update["racialpacmod"] = 1;
						update["racialmacmod"] = 1;
						update["movement"] = 12;
						update["size"] = 0;
						update["stealth_flat"] = 0;
                        break;
                }
                setAttrs(update);
        });
    };
    
    var updateAttack = function(eventinfo) {
        var sourcetype = eventinfo.sourceType;
        var attackid = eventinfo.sourceAttribute.substring(17, 37);
        getAttrs(["level","repeating_attack_atkflag","repeating_attack_atkname_base","repeating_attack_atkattr_base","repeating_attack_atkmod","repeating_attack_atkprofflag","repeating_attack_atkmagic","repeating_attack_dmgflag","repeating_attack_dmgbase","repeating_attack_dmgattr","repeating_attack_dmgmod","repeating_attack_dmgtype","repeating_attack_dmg2flag","repeating_attack_dmg2base","repeating_attack_dmg2attr","repeating_attack_dmg2mod","repeating_attack_dmg2type","strength","dexterity","constitution","intelligence","wisdom","charisma","spellcasting_ability","repeating_attack_dmgcustcrit","repeating_attack_dmg2custcrit","repeating_attack_saveflag","repeating_attack_savedc","repeating_attack_saveeffect","repeating_attack_saveflat","dtype","repeating_attack_hldmg","repeating_attack_spellid","repeating_attack_atkrange","repeating_attack_itemid","globalmagicmod","repeating_attack_ammo"], function(v) {
            var update = {};
            var quietupdate = {};
            var hbonus = "";
            var hdmg1 = "";
            var hdmg2 = "";
            var dmg = "";
            var dmg2 = "";
            var rollbase = "";
            var spellattack = false;
            var magicattackmod = 0;
            var spelllevel = "";
            if(v.repeating_attack_spellid && v.repeating_attack_spellid != "") {
                spellattack = true; 
                magicattackmod = parseInt(v.globalmagicmod, 10);
                spelllevel = "{{spelllevel=" + v["repeating_attack_spellid"].split("_")[0].substr(1) + "}}";
            };
            if(v.repeating_attack_atkattr_base === "0") {atkattr_base = 0} else {atkattr_base = v.repeating_attack_atkattr_base;};
            if(v.repeating_attack_dmgattr === "0") {dmgattr = 0} else {dmgattr = Math.floor((v[v.repeating_attack_dmgattr.substring(0, v.repeating_attack_dmgattr.length - 5).substr(2)] - 10) / 2 );};
            if(v.repeating_attack_dmg2attr === "0") {dmg2attr = 0} else {dmg2attr = Math.floor((v[v.repeating_attack_dmg2attr.substring(0, v.repeating_attack_dmg2attr.length - 5).substr(2)] - 10) / 2 );};
            var dmgbase = v.repeating_attack_dmgbase && v.repeating_attack_dmgbase != "" ? v.repeating_attack_dmgbase : 0;
            var dmg2base = v.repeating_attack_dmg2base && v.repeating_attack_dmg2base != "" ? v.repeating_attack_dmg2base : 0;
            var dmgmod = v.repeating_attack_dmgmod && isNaN(parseInt(v.repeating_attack_dmgmod,10)) === false ? parseInt(v.repeating_attack_dmgmod,10) : 0;
            var dmg2mod = v.repeating_attack_dmg2mod && isNaN(parseInt(v.repeating_attack_dmg2mod,10)) === false ? parseInt(v.repeating_attack_dmg2mod,10) : 0;
            var dmgtype = v.repeating_attack_dmgtype ? v.repeating_attack_dmgtype + " " : "";
            var dmg2type = v.repeating_attack_dmg2type ? v.repeating_attack_dmg2type + " " : "";
            var pb = v.repeating_attack_atkprofflag && v.repeating_attack_atkprofflag != 0 ? (Math.ceil((v.level)/1e10) + Math.ceil((v.level)/4)) : 0;
            var atkmod = v.repeating_attack_atkmod && v.repeating_attack_atkmod != "" ? parseInt(v.repeating_attack_atkmod,10) : 0;
            var atkmag = v.repeating_attack_atkmagic && v.repeating_attack_atkmagic != "" ? parseInt(v.repeating_attack_atkmagic,10) : 0;
            var dmgmag = isNaN(atkmag) === false && atkmag != 0 && ((v.repeating_attack_dmgflag && v.repeating_attack_dmgflag != 0) || (v.repeating_attack_dmg2flag && v.repeating_attack_dmg2flag != 0)) ? "+ " + atkmag + " Magic Bonus" : "";
            var name = v.repeating_attack_atkname_base ? v.repeating_attack_atkname_base : "-";
            if(v.repeating_attack_atkflag && v.repeating_attack_atkflag != 0) {
                bonus_mod = atkattr_base + atkmod + pb + atkmag + magicattackmod;
                plus_minus = bonus_mod > -1 ? "+" : "";
                bonus = plus_minus + bonus_mod;
            }
            else if(v.repeating_attack_saveflag && v.repeating_attack_saveflag != 0) {
                savedcattr = v.repeating_attack_savedc.indexOf("spell") > -1 ? v.spellcasting_ability : v.repeating_attack_savedc;
                savedcattr = savedcattr.replace(/^[^{]*{/,"").replace(/\_.*$/,"");
                if(v.repeating_attack_savedc && v.repeating_attack_savedc === "(@{saveflat})") {
                    var tempdc = isNaN(parseInt(v.repeating_attack_saveflat)) === false ? parseInt(v.repeating_attack_saveflat) : "0";
                }
                else {
                    var tempdc = isNaN(Math.floor((parseInt(v[savedcattr], 10) - 10) / 2) + 8 + pb) === false ? (Math.floor((parseInt(v[savedcattr], 10) - 10) / 2) + 8 + pb) : "0";
                }
                bonus = "DC" + tempdc;
            }
            else {
                bonus = "-";
            }
            if(v.repeating_attack_dmgflag && v.repeating_attack_dmgflag != 0) {
                if(dmgbase === 0 && (dmgattr + dmgmod === 0)){
                    dmg = 0;
                }
                if(dmgbase != 0) {
                    dmg = dmgbase;
                }
                if(dmgbase != 0 && (dmgattr + dmgmod != 0)){
                    dmg = dmgattr + dmgmod > 0 ? dmg + "+" : dmg;
                }
                if(dmgattr + dmgmod != 0) {
                    dmg = dmg + (dmgattr + dmgmod);
                }
                dmg = dmg + " " + dmgtype;
            }
            else {
                dmg = "";
            };
            if(v.repeating_attack_dmg2flag && v.repeating_attack_dmg2flag != 0) {
                if(dmg2base === 0 && (dmg2attr + dmg2mod === 0)){
                    dmg2 = 0;
                }
                if(dmg2base != 0) {
                    dmg2 = dmg2base;
                }
                if(dmg2base != 0 && (dmg2attr + dmg2mod != 0)){
                    dmg2 = dmg2attr + dmg2mod > 0 ? dmg2 + "+" : dmg2;
                }
                if(dmg2attr + dmg2mod != 0) {
                    dmg2 = dmg2 + (dmg2attr + dmg2mod);
                }
                dmg2 = dmg2 + " " + dmg2type;
            }
            else {
                dmg2 = "";
            };
            dmgspacer = v.repeating_attack_dmgflag && v.repeating_attack_dmgflag != 0 && v.repeating_attack_dmg2flag && v.repeating_attack_dmg2flag != 0 ? "+ " : "";
            crit1 = v.repeating_attack_dmgcustcrit && v.repeating_attack_dmgcustcrit != "" ? v.repeating_attack_dmgcustcrit : dmgbase;
            crit2 = v.repeating_attack_dmg2custcrit && v.repeating_attack_dmg2custcrit != "" ? v.repeating_attack_dmg2custcrit : dmg2base;
            r1 = v.repeating_attack_atkflag && v.repeating_attack_atkflag != 0 ? "1d20" : "0d20";
            r2 = v.repeating_attack_atkflag && v.repeating_attack_atkflag != 0 ? "@{rtype}" : "{{r2=[[0d20";
            if(v.repeating_attack_atkflag && v.repeating_attack_atkflag != 0) {
                if(magicattackmod != 0) {hbonus = " + " + magicattackmod + "[SPELLATK]" + hbonus};
                if(atkmag != 0) {hbonus = " + " + atkmag + "[MAGIC]" + hbonus};
                if(pb != 0) {hbonus = " + " + pb + "[PROF]" + hbonus};
                if(atkmod != 0) {hbonus = " + " + atkmod + "[MOD]" + hbonus};
                if(atkattr_base != 0) {hbonus = " + " + atkattr_base + "[" + v.repeating_attack_atkattr_base.substring(2, 5).toUpperCase() + "]" + hbonus};
            }
            else {
                hbonus = "";
            }
            if(v.repeating_attack_dmgflag && v.repeating_attack_dmgflag != 0) {
                if(atkmag != 0) {hdmg1 = " + " + atkmag + "[MAGIC]" + hdmg1};
                if(dmgmod != 0) {hdmg1 = " + " + dmgmod + "[MOD]" + hdmg1};
                if(dmgattr != 0) {hdmg1 = " + " + dmgattr + "[" + v.repeating_attack_dmgattr.substring(2, 5).toUpperCase() + "]" + hdmg1};
                hdmg1 = dmgbase + hdmg1;
            }
            else {
                hdmg1 = "0";
            }
            if(v.repeating_attack_dmg2flag && v.repeating_attack_dmg2flag != 0) {
                if(dmg2mod != 0) {hdmg2 = " + " + dmg2mod + "[MOD]" + hdmg2};
                if(dmg2attr != 0) {hdmg2 = " + " + dmg2attr + "[" + v.repeating_attack_dmg2attr.substring(2, 5).toUpperCase() + "]" + hdmg2};
                hdmg2 = dmg2base + hdmg2;
            }
            else {
                hdmg2 = "0";
            }
            if(v.dtype === "full") {
                pickbase = "full";
                rollbase = "@{wtype}&{template:atkdmg} {{mod=@{atkbonus}}} {{rname=@{atkname}}} {{r1=[[@{hidden_r1base}@{halflingluck}cs>@{atkcritrange}@{hidden_atkbonus}]]}} @{hidden_r2base}@{halflingluck}cs>@{atkcritrange}@{hidden_atkbonus}]]}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[@{hidden_dmg1}]]}} {{dmg1type=@{hidden_dmg1type}}} @{dmg2flag} {{dmg2=[[@{hidden_dmg2}]]}} {{dmg2type=@{hidden_dmg2type}}} {{crit1=[[@{hidden_crit1}]]}} {{crit2=[[@{hidden_crit2}]]}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} @{spelllevel} ammo=@{ammo} @{charname_output}";
            }
            else if(v.repeating_attack_atkflag && v.repeating_attack_atkflag != 0) {
                pickbase = "pick";
                rollbase = "@{wtype}&{template:atk} {{mod=@{atkbonus}}} {{rname=[@{atkname}](~repeating_attack_attack_dmg)}} {{rnamec=[@{atkname}](~repeating_attack_attack_crit)}} {{r1=[[@{hidden_r1base}@{halflingluck}cs>@{atkcritrange}@{hidden_atkbonus}]]}} @{hidden_r2base}@{halflingluck}cs>@{atkcritrange}@{hidden_atkbonus}]]}} {{range=@{atkrange}}} {{desc=@{atk_desc}}} @{spelllevel} ammo=@{ammo} @{charname_output}";
            }
            else if(v.repeating_attack_dmgflag && v.repeating_attack_dmgflag != 0) {
                pickbase = "dmg";
                rollbase = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[@{hidden_dmg1}]]}} {{dmg1type=@{hidden_dmg1type}}} @{dmg2flag} {{dmg2=[[@{hidden_dmg2}]]}} {{dmg2type=@{hidden_dmg2type}}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} @{spelllevel} ammo=@{ammo} @{charname_output}"
            }
            else {
                pickbase = "empty";
                rollbase = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{saveflag} {{desc=@{atk_desc}}} @{spelllevel} ammo=@{ammo} @{charname_output}"
            }
            update["repeating_attack_atkname"] = name;
            update["repeating_attack_atkbonus"] = bonus;
            update["repeating_attack_atkdmgtype"] = dmg + dmgspacer + dmg2 + dmgmag + " ";
            update["repeating_attack_hidden_r1base"] = r1;
            update["repeating_attack_hidden_r2base"] = r2;
            update["repeating_attack_hidden_atkbonus"] = hbonus;
            update["repeating_attack_hidden_dmg1"] = hdmg1;
            update["repeating_attack_hidden_dmg2"] = hdmg2;
            update["repeating_attack_hidden_dmg1type"] = dmgtype;
            update["repeating_attack_hidden_dmg2type"] = dmg2type;
            update["repeating_attack_hidden_crit1"] = crit1 + "[CRIT]";
            update["repeating_attack_hidden_crit2"] = crit2 + "[CRIT]";
            update["repeating_attack_hidden_pickbase"] = pickbase;
            update["repeating_attack_spelllevel"] = spelllevel;
            update["repeating_attack_rollbase"] = rollbase;
            if(sourcetype && sourcetype === "player" && v.repeating_attack_spellid && v.repeating_attack_spellid != "") {
                var spellid = v.repeating_attack_spellid;
                quietupdate["repeating_spell" + spellid + "_spellname_base"] = name;
                if(v.repeating_attack_atkrange && v.repeating_attack_atkrange != "") {
                    quietupdate["repeating_spell" + spellid + "_spellrange"] = v.repeating_attack_atkrange;
                }
                if(dmgbase && dmgbase != 0) {
                    quietupdate["repeating_spell" + spellid + "_spelldamage"] = dmgbase;
                    quietupdate["repeating_spell" + spellid + "_spelldamagetype"] = dmgtype;
                }
                if(dmg2base && dmg2base != 0) {
                    quietupdate["repeating_spell" + spellid + "_spelldamage2"] = dmg2base;
                    quietupdate["repeating_spell" + spellid + "_spelldamagetype2"] = dmg2type;
                }
                if(v.repeating_attack_saveflag && v.repeating_attack_saveflag != "0") {
                    quietupdate["repeating_spell" + spellid + "_spellsave"] = savedcattr;
                    quietupdate["repeating_spell" + spellid + "_spellsavesuccess"] = v.repeating_attack_saveeffect;
                }
            }
            if(sourcetype && sourcetype === "player" && v.repeating_attack_itemid && v.repeating_attack_itemid != "") {
                var itemid = v.repeating_attack_itemid;
                quietupdate["repeating_inventory_" + itemid + "_itemname"] = name;
            }
            setAttrs(quietupdate, {silent: true});
            setAttrs(update);
        });
    };
    
    var updateSpell = function(spellid, category, eventinfo, forceupdate) {
        var sourcetype = eventinfo ? eventinfo.sourceType : "";
        var cat = category ? "-" + category : "";
        var repid = spellid ? spellid + "_" : "";
        var update = {};
        var quietupdate = {};
        var npcspell = false;
        if((eventinfo && eventinfo.sourceAttribute && eventinfo.sourceAttribute.split("_")[1] === "spell-npc") || (category && category === "npc")) {
            npcspell = true;
        }
        getAttrs(["npc_spellattackmod","level","npc_spelldc","repeating_spell" + cat + "_" + repid + "spellname_base","repeating_spell" + cat + "_" + repid + "spellprepared","repeating_spell" + cat + "_" + repid + "spellrange","repeating_spell" + cat + "_" + repid + "spelltarget","repeating_spell" + cat + "_" + repid + "spellattack","repeating_spell" + cat + "_" + repid + "spelldamage","repeating_spell" + cat + "_" + repid + "spelldamagetype","repeating_spell" + cat + "_" + repid + "spelldamage2","repeating_spell" + cat + "_" + repid + "spelldamagetype2","repeating_spell" + cat + "_" + repid + "spellhealing","repeating_spell" + cat + "_" + repid + "spelldmgmod","repeating_spell" + cat + "_" + repid + "spellsave","repeating_spell" + cat + "_" + repid + "spellsavesuccess","repeating_spell" + cat + "_" + repid + "spellhldie","repeating_spell" + cat + "_" + repid + "spellhldietype","repeating_spell" + cat + "_" + repid + "spellhlbonus","repeating_spell" + cat + "_" + repid + "spellattackid","character_id","repeating_spell" + cat + "_" + repid + "spelloutput","repeating_spell" + cat + "_" + repid + "spelllevel","spellcasting_ability"], function(v) {
            update["repeating_spell" + cat + "_" + repid + "spellname"] = v["repeating_spell" + cat + "_" + repid + "spellname_base"] ? v["repeating_spell" + cat + "_" + repid + "spellname_base"] : "";
            update["repeating_spell" + cat + "_" + repid + "prep"] = v["repeating_spell" + cat + "_" + repid + "spellprepared"] ? v["repeating_spell" + cat + "_" + repid + "spellprepared"] : 1;
            update["repeating_spell" + cat + "_" + repid + "spellattackinfoflag"] = v["repeating_spell" + cat + "_" + repid + "spelloutput"] && v["repeating_spell" + cat + "_" + repid + "spelloutput"] === "ATTACK" ? "show" : "hide";
            if(v["repeating_spell" + cat + "_" + repid + "spellattackid"] && v["repeating_spell" + cat + "_" + repid + "spellattackid"] != "") {
                atkid = v["repeating_spell" + cat + "_" + repid + "spellattackid"];
                quietupdate["repeating_spell" + cat + "_" + repid + "rollcontent"] = "%{" + v.character_id + "|repeating_attack_" + atkid + "_attack}";
                if((sourcetype && sourcetype === "player") || (forceupdate && forceupdate === true)) {
                    quietupdate["repeating_attack_" + atkid + "_options-flag"] = "0";
                    quietupdate["repeating_attack_" + atkid + "_atkname_base"] = v["repeating_spell" + cat + "_" + repid + "spellname_base"];
                    if(v["repeating_spell" + cat + "_" + repid + "spellrange"] && v["repeating_spell" + cat + "_" + repid + "spellrange"] != "") {
                        quietupdate["repeating_attack_" + atkid + "_atkrange"] = v["repeating_spell" + cat + "_" + repid + "spellrange"];
                    }
                    if(!v["repeating_spell" + cat + "_" + repid + "spellattack"] || v["repeating_spell" + cat + "_" + repid + "spellattack"] === "None") {
                        quietupdate["repeating_attack_" + atkid + "_atkflag"] = "0";
                    }
                    else {
                        quietupdate["repeating_attack_" + atkid + "_atkattr_base"] = v.spellcasting_ability.slice(0, -1);
                        quietupdate["repeating_attack_" + atkid + "_atkflag"] = "{{attack=1}}";
                    }
                    if(v["repeating_spell" + cat + "_" + repid + "spelldamage"] && v["repeating_spell" + cat + "_" + repid + "spelldamage"] != "") {
                        quietupdate["repeating_attack_" + atkid + "_dmgbase"] = v["repeating_spell" + cat + "_" + repid + "spelldamage"];
                        quietupdate["repeating_attack_" + atkid + "_dmgtype"] = v["repeating_spell" + cat + "_" + repid + "spelldamagetype"] ? v["repeating_spell" + cat + "_" + repid + "spelldamagetype"] : "";
                        quietupdate["repeating_attack_" + atkid + "_dmgflag"] = "{{damage=1}} {{dmg1flag=1}}";
                        if(v["repeating_spell" + cat + "_" + repid + "spelldmgmod"] && v["repeating_spell" + cat + "_" + repid + "spelldmgmod"] === "Yes") {
                            quietupdate["repeating_attack_" + atkid + "_dmgattr"] = v.spellcasting_ability.slice(0, -1);
                        }
                        else {
                            quietupdate["repeating_attack_" + atkid + "_dmgattr"] = "0";
                        }
                    }
                    else {
                        quietupdate["repeating_attack_" + atkid + "_dmgflag"] = "0";
                        quietupdate["repeating_attack_" + atkid + "_dmgbase"] = "";
                        quietupdate["repeating_attack_" + atkid + "_dmgtype"] = "";
                    }
                    if(v["repeating_spell" + cat + "_" + repid + "spelldamage2"] && v["repeating_spell" + cat + "_" + repid + "spelldamage2"] != "") {
                        quietupdate["repeating_attack_" + atkid + "_dmg2flag"] = "{{damage=1}} {{dmg2flag=1}}";
                        quietupdate["repeating_attack_" + atkid + "_dmg2base"] = v["repeating_spell" + cat + "_" + repid + "spelldamage2"];
                        quietupdate["repeating_attack_" + atkid + "_dmg2attr"] = "0";
                        quietupdate["repeating_attack_" + atkid + "_dmg2type"] = v["repeating_spell" + cat + "_" + repid + "spelldamagetype2"];
                    }
                    else {
                        quietupdate["repeating_attack_" + atkid + "_dmg2flag"] = "0";
                        quietupdate["repeating_attack_" + atkid + "_dmg2base"] = "";
                        quietupdate["repeating_attack_" + atkid + "_dmg2type"] = "";
                    }
                    if(v["repeating_spell" + cat + "_" + repid + "spellsave"] && v["repeating_spell" + cat + "_" + repid + "spellsave"] != "") {
                        quietupdate["repeating_attack_" + atkid + "_saveflag"] = "{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}";
                        quietupdate["repeating_attack_" + atkid + "_saveattr"] = v["repeating_spell" + cat + "_" + repid + "spellsave"];
                        quietupdate["repeating_attack_" + atkid + "_saveeffect"] = v["repeating_spell" + cat + "_" + repid + "spellsavesuccess"];
                    }
                    if(v["repeating_spell" + cat + "_" + repid + "spellhldie"] && v["repeating_spell" + cat + "_" + repid + "spellhldie"] != "" && v["repeating_spell" + cat + "_" + repid + "spellhldietype"] && v["repeating_spell" + cat + "_" + repid + "spellhldietype"] != "") {
                        var bonus = "";
                        var spelllevel = v["repeating_spell" + cat + "_" + repid + "spelllevel"];
                        if(!spelllevel) {
                            spelllevel = eventinfo.sourceAttribute.split("_")[1].replace("spell-", "");
                        }
                        var query = "?{Cast at what level?";
                        for(i = 0; i < 10-spelllevel; i++) {
                            query = query + "|Level " + (parseInt(i, 10) + parseInt(spelllevel, 10)) + "," + i;
                        }
                        query = query + "}";
                        if(v["repeating_spell" + cat + "_" + repid + "spellhlbonus"] && v["repeating_spell" + cat + "_" + repid + "spellhlbonus"] != "") {
                            bonus = "+(" + v["repeating_spell" + cat + "_" + repid + "spellhlbonus"] + "*" + query + ")";
                        }
                        quietupdate["repeating_attack_" + atkid + "_hldmg"] = "{{hldmg=[[(" + v["repeating_spell" + cat + "_" + repid + "spellhldie"] + "*" + query + ")" + v["repeating_spell" + cat + "_" + repid + "spellhldietype"] + bonus + "]]}}";
                    }
                    else {
                        quietupdate["repeating_attack_" + atkid + "_hldmg"] = "";
                    }
                    if(v["repeating_spell" + cat + "_" + repid + "spellhealing"] && v["repeating_spell" + cat + "_" + repid + "spellhealing"] != "") {
                        if(!v["repeating_spell" + cat + "_" + repid + "spelldamage"] || v["repeating_spell" + cat + "_" + repid + "spelldamage"] === "") {
                            quietupdate["repeating_attack_" + atkid + "_dmgflag"] = "{{damage=1}} {{dmg1flag=1}}";
                            quietupdate["repeating_attack_" + atkid + "_dmgbase"] = v["repeating_spell" + cat + "_" + repid + "spellhealing"];
                            quietupdate["repeating_attack_" + atkid + "_dmgtype"] = "Healing";
                            if(v["repeating_spell" + cat + "_" + repid + "spelldmgmod"] && v["repeating_spell" + cat + "_" + repid + "spelldmgmod"] === "Yes") {
                                quietupdate["repeating_attack_" + atkid + "_dmgattr"] = v.spellcasting_ability.slice(0, -1);
                            }
                            else {
                                quietupdate["repeating_attack_" + atkid + "_dmgattr"] = "0";
                            }
                        } 
                        else if(!v["repeating_spell" + cat + "_" + repid + "spelldamage2"] || v["repeating_spell" + cat + "_" + repid + "spelldamage2"] === "") {
                            quietupdate["repeating_attack_" + atkid + "_dmg2flag"] = "{{damage=1}} {{dmg2flag=1}}";
                            quietupdate["repeating_attack_" + atkid + "_dmg2base"] = v["repeating_spell" + cat + "_" + repid + "spellhealing"];
                            quietupdate["repeating_attack_" + atkid + "_dmg2type"] = "Healing";
                            if(v["repeating_spell" + cat + "_" + repid + "spelldmgmod"] && v["repeating_spell" + cat + "_" + repid + "spelldmgmod"] === "Yes") {
                                quietupdate["repeating_attack_" + atkid + "_dmg2attr"] = v.spellcasting_ability.slice(0, -1);
                            }
                            else {
                                quietupdate["repeating_attack_" + atkid + "_dmg2attr"] = "0";
                            }
                        }
                    }
                    if(npcspell === true) {
                        var pb = Math.ceil((v.level)/1e10) + Math.ceil((v.level)/4);
                        pb = isNaN(pb) === false ? pb : 0;
                        quietupdate["repeating_attack_" + atkid + "_atkattr_base"] = "0";
                        quietupdate["repeating_attack_" + atkid + "_atkmod"] = v.npc_spellattackmod && isNaN(parseInt(v.npc_spellattackmod, 10)) === false ? parseInt(v.npc_spellattackmod, 10) - pb : 0 - pb;
                        quietupdate["repeating_attack_" + atkid + "_savedc"] = "(@{saveflat})";
                        quietupdate["repeating_attack_" + atkid + "_saveflat"] = v.npc_spelldc && isNaN(parseInt(v.npc_spelldc, 10)) === false ? parseInt(v.npc_spelldc, 10) : 0;
                    }
                }
            }
            setAttrs(quietupdate, {silent: true});
            setAttrs(update);
        });
    };
    
    var updateSpellSlots = function(lvl) {
        if(lvl < 1) {
            l1 = 0; l2 = 0; l3 = 0; l4 = 0; l5 = 0; l6 = 0; l7 = 0; l8 = 0;  l9 = 0;
        }
        else {
            l1 = Math.min((lvl + 1),4);
            if(lvl < 3) {l2 = 0;} else if(lvl === 3) {l2 = 2;} else {l2 = 3;};
            if(lvl < 5) {l3 = 0;} else if(lvl === 5) {l3 = 2;} else {l3 = 3;};
            if(lvl < 7) {l4 = 0;} else if(lvl === 7) {l4 = 1;} else if(lvl === 8) {l4 = 2;} else {l4 = 3;};
            if(lvl < 9) {l5 = 0;} else if(lvl === 9) {l5 = 1;} else if(lvl < 18) {l5 = 2;} else {l5 = 3;};
            if(lvl < 11) {l6 = 0;} else if(lvl < 19) {l6 = 1;} else {l6 = 2;};
            if(lvl < 13) {l7 = 0;} else if(lvl < 20) {l7 = 1;} else {l7 = 2;};
            if(lvl < 15) {l8 = 0;} else {l8 = 1;};
            if(lvl < 17) {l9 = 0;} else {l9 = 1;};
        }
        
        setAttrs({
            lvl1_slots_total: l1,
            lvl2_slots_total: l2,
            lvl3_slots_total: l3,
            lvl4_slots_total: l4,
            lvl5_slots_total: l5,
            lvl6_slots_total: l6,
            lvl7_slots_total: l7,
            lvl8_slots_total: l8,
            lvl9_slots_total: l9
        });
    };
    
    var force_refresh_spells = function() {
        spellcats = ["cantrip","1","2","3","4","5","6","7","8","9","npc"];
        _.each(spellcats, function(cat) {
            getSectionIDs("repeating_spell-" + cat, function(idarray) {
                _.each(idarray, function(currentID, i) {
                    updateSpell(currentID,cat,"",true);
                });
            });
        })
    }

    var force_refresh_attacks = function() {
        getSectionIDs("repeating_attack", function(idarray) {
            _.each(idarray, function(currentID, i) {
                getAttrs(["repeating_attack_" + currentID + "_updateflag"], function(v) {
                    var update = {};
                    var toggle = v["repeating_attack_" + currentID + "_updateflag"] === true ? false : true;
                    update["repeating_attack_" + currentID + "_updateflag"] = toggle;
                    setAttrs(update);
                });
            });
        });
    }
	
</script>